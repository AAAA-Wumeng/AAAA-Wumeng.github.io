<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />

    

    
    <title>Hive | Hexo</title>
    
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    <meta name="keywords" content="数据仓库软件" />
    
    <meta name="description" content="The Apache Hive ™ data warehouse software facilitates reading, writing, and managing large datasets residing in distributed storage using SQL. Structure can be projected onto data already in storage.">
<meta property="og:type" content="article">
<meta property="og:title" content="Hive">
<meta property="og:url" content="http://example.com/2021/12/13/Hive/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="The Apache Hive ™ data warehouse software facilitates reading, writing, and managing large datasets residing in distributed storage using SQL. Structure can be projected onto data already in storage.">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/2021/12/13/Hive/i.qqkou.com&app=2002&size=f9999,10000&q=a80&n=0&g=0n&fmt=jpeg">
<meta property="article:published_time" content="2021-12-13T08:47:54.000Z">
<meta property="article:modified_time" content="2022-05-31T02:04:28.893Z">
<meta property="article:author" content="Wumeng">
<meta property="article:tag" content="数据仓库软件">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/2021/12/13/Hive/i.qqkou.com&app=2002&size=f9999,10000&q=a80&n=0&g=0n&fmt=jpeg">
    

    
        <link rel="alternate" href="/" title="Hexo" type="application/atom+xml" />
    

    

    
<link rel="stylesheet" href="/libs/font-awesome/css/font-awesome.min.css">

    
<link rel="stylesheet" href="/libs/titillium-web/styles.css">

    
<link rel="stylesheet" href="/libs/source-code-pro/styles.css">


    
<link rel="stylesheet" href="/css/style.css">


    
<script src="/libs/jquery/3.5.0/jquery.min.js"></script>

    
    
        
<link rel="stylesheet" href="/libs/lightgallery/css/lightgallery.min.css">

    
    
        
<link rel="stylesheet" href="/libs/justified-gallery/justifiedGallery.min.css">

    
    
    
    


<meta name="generator" content="Hexo 5.4.0"></head>

<body>
    <div id="wrap">
        <header id="header">
    <div id="header-outer" class="outer">
        <div class="container">
            <div class="container-inner">
                <div id="header-title">
                    <h1 class="logo-wrap">
                        <a href="/" class="logo"></a>
                    </h1>
                    
                </div>
                <div id="header-inner" class="nav-container">
                    <a id="main-nav-toggle" class="nav-icon fa fa-bars"></a>
                    <div class="nav-container-inner">
                        <ul id="main-nav">
                            
                                <li class="main-nav-list-item" >
                                    <a class="main-nav-list-link" href="/">主页</a>
                                </li>
                            
                                    <ul class="main-nav-list"><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/Linux/">Linux</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/NoSQL/">NoSQL</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/python/">python</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/">中间件</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/%E5%9F%BA%E7%A1%80/">基础</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/">大数据</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/%E5%AD%A6%E4%B9%A0/">学习</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/%E5%AE%89%E5%85%A8%E8%AE%BE%E5%A4%87/">安全设备</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/%E5%AE%B9%E5%99%A8/">容器</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/%E7%AE%97%E6%B3%95/">算法</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/%E9%A1%B9%E7%9B%AE/">项目</a></li></ul>
                                
                                <li class="main-nav-list-item" >
                                    <a class="main-nav-list-link" href="/about/index.html">关于</a>
                                </li>
                            
                        </ul>
                        <nav id="sub-nav">
                            <div id="search-form-wrap">

    <form class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="搜索" />
        <button type="submit" class="search-form-submit"></button>
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="想要查找什么..." />
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '文章',
            PAGES: '页面',
            CATEGORIES: '分类',
            TAGS: '标签',
            UNTITLED: '(未命名)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>

<script src="/js/insight.js"></script>


</div>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>
</header>

        <div class="container">
            <div class="main-body container-inner">
                <div class="main-body-inner">
                    <section id="main">
                        <div class="main-body-header">
    <h1 class="header">
    
    <a class="page-title-link" href="/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/">大数据</a>
    </h1>
</div>

                        <div class="main-body-content">
                            <article id="post-Hive" class="article article-single article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
            <header class="article-header">
                
    
        <h1 class="article-title" itemprop="name">
        Hive
        </h1>
    

            </header>
        
        
            <div class="article-meta">
                <span id="busuanzi_container_page_pv" style='display:none' class="article-date">
  <i class="icon-smile icon"></i> 阅读数：<span id="busuanzi_value_page_pv"></span>次
</span>

  <div class="article-date">
    <i class="fa fa-calendar"></i>
    <a href="/2021/12/13/Hive/" class="article-date">
       <time datetime="2021-12-13T08:47:54.000Z" itemprop="datePublished">2021-12-13</time>
    </a>
  </div>


<div class="article-date">
  <i class="fa fa-calendar-plus-o"></i>
  <a href="/2021/12/13/Hive/" class="article-date">
     <time datetime="2022-05-31T02:04:28.893Z" itemprop="dateModified">2022-05-31</time>
  </a>
</div>


                

                
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link-link" href="/tags/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%E8%BD%AF%E4%BB%B6/" rel="tag">数据仓库软件</a>
    </div>

                

                

            </div>
        
        
        <div class="article-entry" itemprop="articleBody">
            

            

            

            <p><img src="/2021/12/13/Hive/i.qqkou.com&app=2002&size=f9999,10000&q=a80&n=0&g=0n&fmt=jpeg" alt="img"></p>
<p>The Apache Hive ™ data warehouse software facilitates reading, writing, and managing large datasets residing in distributed storage using SQL. Structure can be projected onto data already in storage. A command line tool and JDBC driver are provided to connect users to Hive.</p>
<h1 id="Hive"><a href="#Hive" class="headerlink" title="Hive"></a>Hive</h1><p>Facebook开源的一个海量结构化日志数据统计（统计大量的数据，只输出一个精华的结果）</p>
<p>Hive是基于Hadoop的一个数据仓库工具，可以将结构化的数据文件映射为一张表，并提供<strong>类SQL</strong>查询功能</p>
<p>本质是将HQL转化为MapReduce程序</p>
<h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><h5 id="Hive是一个数据仓库软件"><a href="#Hive是一个数据仓库软件" class="headerlink" title="Hive是一个数据仓库软件"></a>Hive是一个数据仓库软件</h5><ul>
<li><p>Hive可以使用SQL来促进对已经存在在分布式设备中的数据进行读，写和管理等操作！</p>
</li>
<li><p>Hive在使用时，需要对已经存储的数据进行结构的投影(映射)</p>
</li>
<li><p>Hive提供了一个命令行和JDBC的方式，让用户可以连接到hive！</p>
</li>
</ul>
<p>注意：Hive只能分析<strong>结构化</strong>的数据！（处理存储在Hadoop中的<strong>结构化</strong>数据）<br>Hive在Hadoop之上，使用hive的前提是先要安装Hadoop</p>
<h5 id="特点"><a href="#特点" class="headerlink" title="特点"></a>特点</h5><ul>
<li>Hive不是一个关系型数据库</li>
<li>不是基于OLTP(在线事务处理)设计<ul>
<li>OLTP设计的软件：侧重点在事务的处理，和在线访问。一般RDMS都是基于OLTP设计</li>
</ul>
</li>
<li>Hive无法做到实时查询，不支持行级别更新(update,delete)</li>
<li>Hive要分析的数据存储在HDFS，hive为数据创建的表结构(schema)，存储在RDMS</li>
<li>Hive基于OLAP(在线分析处理)设计<ul>
<li>OLAP设计的软件：侧重点在数据的分析上，不追求分析的效率！</li>
</ul>
</li>
<li>Hive使用类SQL，称为HQL对数据进行分析</li>
<li>Hive容易使用，可扩展，有弹性</li>
</ul>
<h2 id="Hive和关系型数据库的对比"><a href="#Hive和关系型数据库的对比" class="headerlink" title="Hive和关系型数据库的对比"></a>Hive和关系型数据库的对比</h2><p><strong>数据存储位置</strong></p>
<p>Hive 是建立在 Hadoop 之上的，所有 Hive 的数据都是存储在 HDFS 中的。而数据库则可以将数据保存在块设备或者本地文件系统中。</p>
<p><strong>数据更新</strong></p>
<p>由于Hive是针对数据仓库应用设计的，而<strong>数据仓库的内容是读多写少的</strong>。因此，<strong>Hive中不建议对数据的改写，所有的数据都是在加载的时候确定好的</strong>。而数据库中的数据通常是需要经常进行修改的，因此可以使用 INSERT INTO … VALUES 添加数据，使用 UPDATE … SET修改数据。</p>
<p><strong>索引</strong></p>
<p>Hive在加载数据的过程中不会对数据进行任何处理，甚至不会对数据进行扫描，因此也没有对数据中的某些Key建立索引。<strong>Hive要访问数据中满足条件的特定值时，需要暴力扫描整个数据</strong>，因此访问延迟较高。由于 MapReduce 的引入， Hive 可以并行访问数据，因此即使没有索引，对于大数据量的访问，Hive 仍然可以体现出优势。数据库中，通常会针对一个或者几个列建立索引，因此对于少量的特定条件的数据的访问，数据库可以有很高的效率，较低的延迟。由于数据的访问延迟较高，决定了 Hive 不适合在线数据查询。</p>
<p><strong>执行</strong></p>
<p>Hive中大多数查询的执行是通过 Hadoop 提供的 MapReduce 来实现的。而数据库通常有自己的执行引擎。</p>
<p><strong>执行延迟</strong></p>
<p>Hive 在查询数据的时候，由于没有索引，需要扫描整个表，因此延迟较高。另外一个导致 Hive 执行延迟高的因素是 MapReduce框架。由于MapReduce 本身具有较高的延迟，因此在利用MapReduce 执行Hive查询时，也会有较高的延迟。相对的，数据库的执行延迟较低。当然，这个低是有条件的，即数据规模较小，当数据规模大到超过数据库的处理能力的时候，Hive的并行计算显然能体现出优势。</p>
<p><strong>可扩展性</strong></p>
<p>由于Hive是建立在Hadoop之上的，因此Hive的可扩展性是和Hadoop的可扩展性是一致的。而数据库由于 ACID 语义的严格限制，扩展行非常有限。</p>
<p><strong>数据规模</strong></p>
<p>由于Hive建立在集群上并可以利用MapReduce进行并行计算，因此可以支持很大规模的数据；对应的，数据库可以支持的数据规模较小。</p>
<h2 id="Hive的安装"><a href="#Hive的安装" class="headerlink" title="Hive的安装"></a>Hive的安装</h2><p>Hive是用Java写的，必须保证有JAVA_HOME、HADOOP_HOME</p>
<p><img src="/2021/12/13/Hive/image-20211213212603207.png" alt="image-20211213212603207"></p>
<p>Hive是一个客户端，可以安装在Hadoop的任意节点上</p>
<ul>
<li>1、上传对应的安装文件到指定的目录下，然后解压至安装目录：</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar -zxvf apache-hive-1.2.1-bin.tar.gz -C ../module/</span><br></pre></td></tr></table></figure>

<p><img src="/2021/12/13/Hive/image-20211213211441621.png" alt="image-20211213211441621"></p>
<ul>
<li>分析目录文件</li>
</ul>
<p><img src="/2021/12/13/Hive/image-20211213212201252.png" alt="image-20211213212201252"></p>
<ul>
<li>3、Hive会将分析后的数据存入关系数据库，支持的数据库类型如下：</li>
</ul>
<p><img src="/2021/12/13/Hive/image-20211213212344817.png" alt="image-20211213212344817"></p>
<ul>
<li>4、进入你的环境变量的配置文件，新增Hive的路径变量</li>
</ul>
<p><img src="/2021/12/13/Hive/image-20211213213513880.png" alt="image-20211213213513880"> </p>
<h5 id="常见操作"><a href="#常见操作" class="headerlink" title="常见操作"></a>常见操作</h5><ul>
<li>使用hive命令进入</li>
</ul>
<p><img src="/2021/12/13/Hive/image-20211213214531858.png" alt="image-20211213214531858"></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show databases;	#查看数据库</span><br></pre></td></tr></table></figure>

<p><img src="/2021/12/13/Hive/image-20211213214644379.png" alt="image-20211213214644379"></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">use default;	#使用default数据库</span><br></pre></td></tr></table></figure>

<p><img src="/2021/12/13/Hive/image-20211213214737556.png" alt="image-20211213214737556"></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">创建一张表</span><br></pre></td></tr></table></figure>

<p><img src="/2021/12/13/Hive/image-20211213214956456.png" alt="image-20211213214956456"></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">查看新创建的表</span><br></pre></td></tr></table></figure>

<p><img src="/2021/12/13/Hive/image-20211213220447425.png" alt="image-20211213220447425"></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">先新建的表中插入数据</span><br></pre></td></tr></table></figure>

<p><img src="/2021/12/13/Hive/image-20211213220646484.png" alt="image-20211213220646484"></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">查询插入的结果</span><br></pre></td></tr></table></figure>

<p><img src="/2021/12/13/Hive/image-20211213220741008.png" alt="image-20211213220741008"></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">执行删除操作，报错，不支持删除和更新</span><br></pre></td></tr></table></figure>

<p><img src="/2021/12/13/Hive/image-20211213220858585.png" alt="image-20211213220858585"></p>
<p>在WEB页面查看创建的表：</p>
<p><img src="/2021/12/13/Hive/image-20211214094653171.png" alt="image-20211214094653171"></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">查看Hive建表的语句</span><br></pre></td></tr></table></figure>

<p><img src="/2021/12/13/Hive/image-20211214102009494.png" alt="image-20211214102009494"></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">创建表，并指定文件的分隔符</span><br></pre></td></tr></table></figure>

<p><img src="/2021/12/13/Hive/image-20211214104204724.png" alt="image-20211214104204724"></p>
<h2 id="Hive数据的存储"><a href="#Hive数据的存储" class="headerlink" title="Hive数据的存储"></a>Hive数据的存储</h2><ul>
<li>Hive要分析的数据是存储在HDFS上<ul>
<li>Hive中的库的位置，在HDFS上就是一个目录</li>
<li>Hive中的表的位置，在HDFS上是一个目录，在所在的库目录下创建了一个子目录</li>
</ul>
</li>
<li>在Hive中，存储的数据必须是结构化的数据，而且这个数据的格式和表的数属性要将紧密相关<ul>
<li>表在创建的时候是有分隔符属性的，分隔符表示，在执行MR程序时，使用那个分隔符去分隔每行中的字段（如果分隔符指定的有问题，那么分隔符就不能正确的读到）</li>
</ul>
</li>
<li>Hive中默认的记录和字段分隔符</li>
</ul>
<table>
<thead>
<tr>
<th>分隔符</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>\n</td>
<td>对于文本来说，每行都是一条记录，因此换行符可以分隔记录</td>
</tr>
<tr>
<td>^A（Ctrl + A）</td>
<td>用于分隔字段（列）。在CREATE TABLE语句中使用八进制编码\001表示【字段】</td>
</tr>
<tr>
<td>^B</td>
<td>用于分隔ARRARY或者STRUCT中的元素，或用于MAP中键值对之间的分隔，在CREATE TABLE语句中可以使用八进制编码\002表示【集合】</td>
</tr>
<tr>
<td>^C</td>
<td>用于MAP中键和值之间的分隔，在CREATE TABLE中可以使用八进制编码\003表示【key-value】</td>
</tr>
</tbody></table>
<h3 id="Hive中的元数据（schema）"><a href="#Hive中的元数据（schema）" class="headerlink" title="Hive中的元数据（schema）"></a>Hive中的元数据（schema）</h3><p>存储在关系数据库里边，如果没有安装关系型数据库（MySQL），则默认存储在derby中。</p>
<p>derby：是使用Java语言编写的一个微型，常用于内嵌在Java中的数据库；缺陷是同一个数据库文件不支持多个客户端同时访问。</p>
<h3 id="设置Hive的元数据的存储设置存储在MySQL中"><a href="#设置Hive的元数据的存储设置存储在MySQL中" class="headerlink" title="设置Hive的元数据的存储设置存储在MySQL中"></a>设置Hive的元数据的存储设置存储在MySQL中</h3><p>MySQL5.7安装：<a target="_blank" rel="noopener" href="https://blog.csdn.net/m0_51510236/article/details/113791490">https://blog.csdn.net/m0_51510236/article/details/113791490</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ps -ef | grep mysql		#查询正在运行的mysql进程</span><br></pre></td></tr></table></figure>

<h5 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h5><p><strong>需要配置hive的conf的配置文件</strong></p>
<ul>
<li>新增hive-site.xml配置。</li>
</ul>
<p><img src="/2021/12/13/Hive/image-20211214173350046.png" alt="image-20211214173350046"></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&lt;?xml version=&quot;1.0&quot;?&gt;</span><br><span class="line">&lt;?xml-stylesheet type=&quot;text/xsl&quot; href=&quot;configuration.xsl&quot;?&gt;</span><br><span class="line">&lt;configuration&gt;</span><br><span class="line">        &lt;property&gt;</span><br><span class="line">          &lt;name&gt;javax.jdo.option.ConnectionURL&lt;/name&gt;</span><br><span class="line">          &lt;value&gt;jdbc:mysql://hadoop102:3306/metastore?createDatabaseIfNotExist=true&lt;/value&gt;</span><br><span class="line">          &lt;description&gt;JDBC connect string for a JDBC metastore&lt;/description&gt;</span><br><span class="line">        &lt;/property&gt;</span><br><span class="line"></span><br><span class="line">        &lt;property&gt;</span><br><span class="line">          &lt;name&gt;javax.jdo.option.ConnectionDriverName&lt;/name&gt;</span><br><span class="line">          &lt;value&gt;com.mysql.jdbc.Driver&lt;/value&gt;</span><br><span class="line">          &lt;description&gt;Driver class name for a JDBC metastore&lt;/description&gt;</span><br><span class="line">        &lt;/property&gt;</span><br><span class="line"></span><br><span class="line">        &lt;property&gt;</span><br><span class="line">          &lt;name&gt;javax.jdo.option.ConnectionUserName&lt;/name&gt;</span><br><span class="line">          &lt;value&gt;root&lt;/value&gt;</span><br><span class="line">          &lt;description&gt;username to use against metastore database&lt;/description&gt;</span><br><span class="line">        &lt;/property&gt;</span><br><span class="line"></span><br><span class="line">        &lt;property&gt;</span><br><span class="line">          &lt;name&gt;javax.jdo.option.ConnectionPassword&lt;/name&gt;</span><br><span class="line">          &lt;value&gt;java&lt;/value&gt;</span><br><span class="line">          &lt;description&gt;password to use against metastore database&lt;/description&gt;</span><br><span class="line">        &lt;/property&gt;</span><br><span class="line">&lt;/configuration&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>配置jar包：在hive的lib文件夹下，新增MySQL的驱动Jar包</li>
</ul>
<p>启动hive，创建table时，会在metastore数据库中生成数据库表。</p>
<p>TBLS：存放的表的信息</p>
<p><img src="/2021/12/13/Hive/image-20211214174449584.png" alt="image-20211214174449584"></p>
<p>DBS：存放hive中有那些库的信息</p>
<p><img src="/2021/12/13/Hive/image-20211214174555552.png" alt="image-20211214174555552"></p>
<p>新建table的字段保存</p>
<p><img src="/2021/12/13/Hive/image-20211214175259070.png" alt="image-20211214175259070"></p>
<p>其中CD_ID表示表ID</p>
<p>元数据的结构：</p>
<ul>
<li>表的信息都存储在tbls表中，通过db_id和DBS表中的库进行外键约束</li>
<li>库的信息都存放在dbs表中</li>
<li>字段信息保存在column_v2中，通过CD_ID和表的主键进行约束。</li>
</ul>
<h4 id="操作Hive的方式"><a href="#操作Hive的方式" class="headerlink" title="操作Hive的方式"></a>操作Hive的方式</h4><ul>
<li>使用beeline</li>
</ul>
<p><img src="/2021/12/13/Hive/image-20211214180043587.png" alt="image-20211214180043587"></p>
<p>先启动hiveserver2</p>
<p><img src="/2021/12/13/Hive/image-20211215154437297.png" alt="image-20211215154437297"></p>
<p>使用beeline连接</p>
<p><img src="/2021/12/13/Hive/image-20211215154554157.png" alt="image-20211215154554157"></p>
<p>退出连接</p>
<p><img src="/2021/12/13/Hive/image-20211215163857322.png" alt="image-20211215163857322"></p>
<h3 id="常用配置"><a href="#常用配置" class="headerlink" title="常用配置"></a>常用配置</h3><p>1、配置Hive数据仓库的位置，在HIve的配置文件中添加如下内容：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">name</span>&gt;</span>hive.metastore.warehouse.dir<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">value</span>&gt;</span>/user/hive/warehouse<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">description</span>&gt;</span>location of default database for the warehouse<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>2、增加查询后显示配置</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">name</span>&gt;</span>hive.cli.print.header<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">value</span>&gt;</span>true<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">name</span>&gt;</span>hive.cli.print.current.db<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">value</span>&gt;</span>true<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>3、修改日志文件的输出位置</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mv hive-log4j.properties.template hive-log4j.properties		<span class="comment">#日志输出的配置文件</span></span><br></pre></td></tr></table></figure>

<p>输出的日志文件的路径；</p>
<p><img src="/2021/12/13/Hive/image-20211215181131036.png" alt="image-20211215181131036"></p>
<h3 id="常用交互参数"><a href="#常用交互参数" class="headerlink" title="常用交互参数"></a>常用交互参数</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hive --service hiveserver2		#使用hive命令启动hiveserver2</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">d,--define &lt;key=value&gt;          Variable subsitution to apply to hive</span><br><span class="line">                                  commands. e.g. -d A=B or --define A=B</span><br><span class="line">    定义一个变量，在hive启动之后，可以使用$&#123;变量名&#125;引用变量。</span><br><span class="line">    --database &lt;databasename&gt;     Specify the database to use</span><br><span class="line">    指定使用那个库</span><br><span class="line"> -e &lt;quoted-query-string&gt;         SQL from command line</span><br><span class="line"> 指定命令行获取一条引号引起来的sql，执行完返回结果后退出cli.</span><br><span class="line"> -f &lt;filename&gt;                    SQL from files</span><br><span class="line"> 执行一个文件中的所有SQL语句！执行完返回结果后退出cli.</span><br><span class="line"> -H,--help                        Print help information</span><br><span class="line">    --hiveconf &lt;property=value&gt;   Use value for given property</span><br><span class="line">    在客户端运行之前定义一组属性</span><br><span class="line">    Hive是基于Hadoop的，在运行时先读取Hadooop的8个配置文件，然后再读取hive-default.xml，然后再读取自定义的hive-site.xml，如果使用了--hiveconf这个定义的属性会覆盖之前读到的参数的值</span><br><span class="line">    --hivevar &lt;key=value&gt;         Variable subsitution to apply to hive</span><br><span class="line">                                  commands. e.g. --hivevar A=B</span><br><span class="line">                                  作用和-d是一致的</span><br><span class="line"> -i &lt;filename&gt;                    Initialization SQL file</span><br><span class="line"> 初始化sql文件，与-f的区别是，运行之后，不退出客户端</span><br><span class="line"> -S,--silent                      Silent mode in interactive shell</span><br><span class="line"> 不打印和结果无关的数据</span><br><span class="line"> -v,--verbose                     Verbose mode (echo executed SQL to the</span><br><span class="line">                                  console)</span><br><span class="line">                                  把执行的sql打印到控制台</span><br></pre></td></tr></table></figure>

<p><strong>在Hive客户端中操作Hadoop命令</strong></p>
<p>因为Hive是直接运行在，hadoop上的，所以在Hive客户端中运行Hadoop命令，只需要加上dfs即可；执行linux命令，只需要在命令前加上**!**</p>
<h2 id="Hive的数据类型"><a href="#Hive的数据类型" class="headerlink" title="Hive的数据类型"></a>Hive的数据类型</h2><p>Map和Struct的区别：</p>
<ul>
<li>Struct中属性名是不变的；Map中的Key可以变化</li>
</ul>
<p>注意：在一个表中，array每个元素之间的分隔符和Map每个Entry之间的分隔符和Struct每个属性之间的分隔符需要一致。</p>
<p>array使用下标来定位；</p>
<p><img src="/2021/12/13/Hive/image-20211215205110245.png" alt="image-20211215205110245"></p>
<p>Map通过key来获取值</p>
<p><img src="/2021/12/13/Hive/image-20211215205334491.png" alt="image-20211215205334491"></p>
<p>Struct通过结构体.属性名来获取</p>
<p><img src="/2021/12/13/Hive/image-20211215205527403.png" alt="image-20211215205527403"></p>
<h2 id="类型的转换"><a href="#类型的转换" class="headerlink" title="类型的转换"></a>类型的转换</h2><h4 id="隐式类型转换规则"><a href="#隐式类型转换规则" class="headerlink" title="隐式类型转换规则"></a>隐式类型转换规则</h4><h4 id="使用CAST操作显示进行数据类型的转换"><a href="#使用CAST操作显示进行数据类型的转换" class="headerlink" title="使用CAST操作显示进行数据类型的转换"></a>使用CAST操作显示进行数据类型的转换</h4><h2 id="Hive库常见的操作"><a href="#Hive库常见的操作" class="headerlink" title="Hive库常见的操作"></a>Hive库常见的操作</h2><p><strong>注意：</strong>在Hive中语句是不区分大下写，但是在参数中严格区分大小写</p>
<p>增</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">CREATE (DATABASE|SCHENA) [IF NOT EXISTS] database_name</span><br><span class="line">[COMMENT database_comment]	#库的注释说明</span><br><span class="line">[LOCATION hdfs_path]		#库在HDFS上的路径</span><br><span class="line">[WITH DBPROPERTIES	(property_name=property_value...)]		#库的属性</span><br></pre></td></tr></table></figure>

<p>删</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">drop database 库名		#只能删除空库</span><br><span class="line">drop database 库名 cascade;	#删除数据库，包含数据库中的表【删除非空库】</span><br></pre></td></tr></table></figure>

<p>改</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">use 库名		#切换库</span><br><span class="line">dbproperties:alter database 库名 set dbproperties([这里写属性])</span><br><span class="line"><span class="meta">#</span><span class="bash">	修改属性，同名的属性会覆盖，之前没有的属性会新增</span></span><br><span class="line"><span class="meta">#</span><span class="bash">	hive在修改属性时，是严格区分大小写的</span></span><br></pre></td></tr></table></figure>

<p>查</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">show databases		#查看当前所有的库</span><br><span class="line">show tables in database		#查看库中所有的表</span><br><span class="line">desc database 库名	#查看库的详细描述信息</span><br><span class="line">desc database extended 库名	#查看库的详细描述信息</span><br></pre></td></tr></table></figure>

<h2 id="Hive库表见的操作"><a href="#Hive库表见的操作" class="headerlink" title="Hive库表见的操作"></a>Hive库表见的操作</h2><h3 id="增"><a href="#增" class="headerlink" title="增"></a>增</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">CREATE [EXTERNAL] TABLE [IF NOT EXISTS] table_name </span><br><span class="line">[(col_name data_type [COMMENT col_comment], ...)] </span><br><span class="line"><span class="meta">#</span><span class="bash">表中包含哪些列，包含列名，列的类型；COMMENT表示列的注释</span></span><br><span class="line">[COMMENT table_comment] 	#表的注释</span><br><span class="line">[PARTITIONED BY (col_name data_type [COMMENT col_comment], ...)] #分区表</span><br><span class="line"></span><br><span class="line">[CLUSTERED BY (col_name, col_name, ...) #分桶表</span><br><span class="line">[SORTED BY (col_name [ASC|DESC], ...)] INTO num_buckets BUCKETS] </span><br><span class="line">[ROW FORMAT row_format] 	#表中数据每行的格式，定义数据字段的分隔符，集合元素的分隔符</span><br><span class="line">[STORED AS file_format] 	#表中的数据以什么样的格式来存（默认是文本文件【TEXTFILE】，也可以设置成【SequenFile】或者是其他的格式）</span><br><span class="line">[LOCATION hdfs_path]	#表在hdfs上的位置</span><br></pre></td></tr></table></figure>

<ul>
<li>建表时，不带EXTERNAL，创建的表是一个MANAGED_TABLE（管理表）；建表时带了EXTERNAL，就是一个外部表<ul>
<li>内部表或者管理表在执行删除操作时，会将表的元数据（schema）和表位置的数据一起删除</li>
<li>外部表在执行删除表操作时，只删除表的元数据（schema）</li>
</ul>
</li>
<li>建表语句执行时：<ul>
<li>hive会在hdfs中生成表的路径</li>
<li>hive还会向MySQL的metastore库中插入两条表的信息（表的元数据）</li>
</ul>
</li>
<li>内部表和外部表的切换</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">alter table 表名 set tblproperties(&#x27;EXTERNAL&#x27;=&#x27;TRUE&#x27;)	#将内部表转为外部表</span><br><span class="line">alter table 表名 set tblproperties(&#x27;EXTERNAL&#x27;=&#x27;FALSE&#x27;)	#将外部表转为管理表</span><br></pre></td></tr></table></figure>

<h4 id="分区表："><a href="#分区表：" class="headerlink" title="分区表："></a>分区表：</h4><p>在创建表的时候指定了PARTITIONED BY，这个表称为分区表</p>
<ul>
<li><p>分区的概念</p>
<ul>
<li>MR：在MapTask输出key-value时，为每一个key-value计算一个分区号，同一个分区的数据，会被同一个reduceTask处理，这个分区的数据，最终生成一个结果文件。<ul>
<li>通过分区，将MapTask输出的key-value经过reduce后，分散到多个不同的结果文件中。</li>
</ul>
</li>
<li>Hive：将表中的数据，分散到表目录下的多个子目录（分区目录）中</li>
</ul>
</li>
<li><p>分区的目的：将数据分撒到多个不同的子目录中；在执行查询时，可以只选择查询某些子目录中的数据（使用分区列进行过滤），加快查询效率；只有分区表采油子目录（分区目录）；</p>
<ul>
<li>分区目录的名称由两部分确定：分区列的列名=分区列的列值</li>
<li>分区的查询</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show partitions 表名</span><br></pre></td></tr></table></figure>

<ul>
<li>创建分区 1</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">alter table 表名 add partition(分区字段名=分区字段值)	#创建单个分区</span><br><span class="line"><span class="meta">#</span><span class="bash">同时创建多个分区，中间使用空格分隔</span></span><br><span class="line">alter table dept_partition add partition(month=&#x27;201705&#x27;) partition(month=&#x27;201704&#x27;);</span><br></pre></td></tr></table></figure>

<ul>
<li>创建分区2：直接使用load命令向分区加载数据，如果分区不存在，load时自动生成分区</li>
</ul>
</li>
</ul>
<p><img src="/2021/12/13/Hive/image-20211216182627458.png" alt="image-20211216182627458"></p>
<p>删除分区</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">alter table dept_partition drop partition (month=&#x27;201704&#x27;);		#删除单个分区</span><br><span class="line"><span class="meta">#</span><span class="bash">删除多个分区，多个分区之间用逗号间隔</span></span><br><span class="line">alter table dept_partition drop partition (month=&#x27;201705&#x27;), partition (month=&#x27;201706&#x27;);</span><br></pre></td></tr></table></figure>

<h4 id="分区表实例"><a href="#分区表实例" class="headerlink" title="分区表实例"></a>分区表实例</h4><ul>
<li>创建分区表</li>
</ul>
<p><img src="/2021/12/13/Hive/image-20211216114519379.png" alt="image-20211216114519379"></p>
<ul>
<li>创建要上传的文件，并检查文件的分隔符</li>
</ul>
<p><img src="/2021/12/13/Hive/image-20211216114118935.png" alt="image-20211216114118935"></p>
<ul>
<li>执行</li>
</ul>
<p><img src="/2021/12/13/Hive/image-20211216115034834.png" alt="image-20211216115034834"></p>
<p>报错：目标表已经被分区了，你必须指定分区列。</p>
<p><strong>【如果表是一个分区表，在导入数据时必须指定向那个分区目录导入数据】</strong></p>
<ul>
<li>创建分区，指定分区字段值和分区字段名，并查看结果</li>
</ul>
<p><img src="/2021/12/13/Hive/image-20211216115808777.png" alt="image-20211216115808777"></p>
<p><img src="/2021/12/13/Hive/image-20211216115938433.png" alt="image-20211216115938433"></p>
<p>创建分区后的变化-HDFS：在hdfs上生成分区的路径</p>
<p><img src="/2021/12/13/Hive/image-20211216120041374.png" alt="image-20211216120041374"></p>
<p>创建分区后的变化-MySQL：在partition表中生成元数据</p>
<p><img src="/2021/12/13/Hive/image-20211216120230022.png" alt="image-20211216120230022"></p>
<p>成功向分区表中导入数据</p>
<p><img src="/2021/12/13/Hive/image-20211216120836607.png" alt="image-20211216120836607"></p>
<p>将数据导入到指定分区之后，数据会附加上分区列的信息！</p>
<p><img src="/2021/12/13/Hive/image-20211216182136868.png" alt="image-20211216182136868"></p>
<p>删除分区</p>
<p><img src="/2021/12/13/Hive/image-20211216183628221.png" alt="image-20211216183628221"></p>
<p>删除分区执行的操作：在hive中任何删除，删表，删库都会删除掉元数据；根据表的类型，如果是管理表，就删除数据；如果不是管理表就不删数据。但是执行了删除操作，就会丢失元数据，就不能在查询</p>
<p><img src="/2021/12/13/Hive/image-20211216184042296.png" alt="image-20211216184042296"></p>
<p>创建多级分区表</p>
<p>一个分区字段，就是一级目录</p>
<p>如果表是多级分区表，在导入数据时，数据必须位于最后一级分区的目录</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">create external table if not exists default.deptpart2(</span><br><span class="line">deptno int,</span><br><span class="line">dname string,</span><br><span class="line">loc int</span><br><span class="line">)</span><br><span class="line">PARTITIONED BY(area string,province string)</span><br><span class="line">row format delimited fields terminated by &#x27;\t&#x27;;</span><br></pre></td></tr></table></figure>

<p><img src="/2021/12/13/Hive/image-20211216195648193.png" alt="image-20211216195648193"></p>
<p>向其中添加数据</p>
<p><img src="/2021/12/13/Hive/image-20211216200024946.png" alt="image-20211216200024946"></p>
<p>查看添加后的结果</p>
<p><img src="/2021/12/13/Hive/image-20211216200357081.png" alt="image-20211216200357081"></p>
<h4 id="分桶表"><a href="#分桶表" class="headerlink" title="分桶表"></a>分桶表</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[CLUSTERED BY (col_name, col_name, ...) #分桶表</span><br><span class="line"><span class="meta">#</span><span class="bash">分桶的字段是从表的普通字段中来取</span></span><br><span class="line">[SORTED BY (col_name [ASC|DESC], ...)] INTO num_buckets BUCKETS] </span><br></pre></td></tr></table></figure>

<p>建表时指定CLUSTERED BY，这个表称为分桶表</p>
<p>分桶：和MR中的分区是一个概念；把数据分撒到多个文件中；分桶的本质上也是为了分散数据。在分桶后可以结合hive提供的抽样查询，只查询指定桶的数据。</p>
<h4 id="分桶表实例"><a href="#分桶表实例" class="headerlink" title="分桶表实例"></a>分桶表实例</h4><p>建表</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">create table stu_buck1(id int, name string)</span><br><span class="line">clustered by(id) 	#按照id来进行分桶操作</span><br><span class="line">SORTED BY (id desc)	#按照降序排列</span><br><span class="line">into 4 buckets		#你想要几个结果文件，分几个桶就有几个结果文件</span><br><span class="line">row format delimited fields terminated by &#x27;\t&#x27;;</span><br></pre></td></tr></table></figure>

<p>向分桶表中导入数据</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">create table stu_buck(id int, name string)</span><br><span class="line">clustered by(id)</span><br><span class="line">SORTED BY (id desc)</span><br><span class="line">into 4 buckets</span><br><span class="line">row format delimited fields terminated by &#x27;\t&#x27;;</span><br></pre></td></tr></table></figure>

<p><img src="/2021/12/13/Hive/image-20211217093550684.png" alt="image-20211217093550684"></p>
<p><img src="/2021/12/13/Hive/image-20211217093657293.png" alt="image-20211217093657293"></p>
<p>向分桶表导入数据</p>
<p>向分桶表导入数据时，必须运行MR程序才能实现分桶操作。</p>
<p>load方式，只是执行put操作，无法满足分桶表导入数据。必须执行insert into</p>
<ul>
<li>先建一个临时（普通）表</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">create table stu_buck_tmp(id int, name string)</span><br><span class="line">row format delimited fields terminated by &#x27;\t&#x27;;</span><br></pre></td></tr></table></figure>

<p><img src="/2021/12/13/Hive/image-20211217094542573.png" alt="image-20211217094542573"></p>
<p>先临时表导入数据</p>
<p><img src="/2021/12/13/Hive/image-20211217094913486.png" alt="image-20211217094913486"></p>
<p>查询导入的结果</p>
<p><img src="/2021/12/13/Hive/image-20211217100320868.png" alt="image-20211217100320868"></p>
<p>执行导入【定义了4个分桶，需要启动4个ReduceTask】</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set mapreduce.job.reduces;	#查看Hive启动了多少ReduceTask</span><br></pre></td></tr></table></figure>

<p><img src="/2021/12/13/Hive/image-20211217100541689.png" alt="image-20211217100541689"></p>
<p>当前值是-1，表示由hive自动的设置。</p>
<p>先分桶表导入数据之前，需要打开自动分桶的开关</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">set hive.enforce.bucketing=true;		#强制分桶</span><br><span class="line">set hive.enforce.sorting=true;			#强制排序</span><br></pre></td></tr></table></figure>

<p><img src="/2021/12/13/Hive/image-20211217100825010.png" alt="image-20211217100825010"></p>
<p><img src="/2021/12/13/Hive/image-20211217104926682.png" alt="image-20211217104926682"></p>
<p>向表中插入数据【从临时表中查找数据，然后执行插入操作】</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">insert into table stu_buck select * from stu_buck_tmp;</span><br></pre></td></tr></table></figure>

<p><img src="/2021/12/13/Hive/image-20211217105530945.png" alt="image-20211217105530945"></p>
<p>web界面查看执行的结果</p>
<p><img src="/2021/12/13/Hive/image-20211217105636750.png" alt="image-20211217105636750"></p>
<p>查看一号分区中的内容【分区依据是id模除4（因为分了4个通）】</p>
<p><img src="/2021/12/13/Hive/image-20211217110443329.png" alt="image-20211217110443329"></p>
<p>抽样查询</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from 分桶表 tablesample (bucket x out of y on 分桶表分桶字段)</span><br></pre></td></tr></table></figure>

<ul>
<li><p>抽样查询的表，必须是分桶表</p>
</li>
<li><p>bucket x out of y on 分桶表分桶字段【假设当前桶一共分了z个桶】</p>
<ul>
<li>x：从当前表的第几桶开始抽样</li>
<li>y：z/y代表一共抽多少个桶</li>
<li>要求y必须是z的因子或倍数；0&lt;x&lt;y； </li>
</ul>
<p>抽取方法：</p>
<ul>
<li>从第X桶开始抽样，每次间隔y桶抽一桶，直到抽满z/y桶</li>
</ul>
</li>
</ul>
<p>示例：一共有四个桶（z）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bucket 1 out of 1 on id;	#从第一桶（0号桶）开始抽，每隔两桶（y）抽一桶，一共抽2(z/y)桶：抽取的是0，2</span><br></pre></td></tr></table></figure>

<p><img src="/2021/12/13/Hive/image-20211217112646494.png" alt="image-20211217112646494"></p>
<p>查</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">desc 表名	#查看表的描述</span><br><span class="line">desc extended 表名	#查看表的详细描述信息</span><br><span class="line">desc formated 表名	#带格式化的详细信息</span><br></pre></td></tr></table></figure>

<p>查看表的描述数据</p>
<p><img src="/2021/12/13/Hive/image-20211216104844907.png" alt="image-20211216104844907"></p>
<p>查看表的详细数据</p>
<p><img src="/2021/12/13/Hive/image-20211216104803637.png" alt="image-20211216104803637"></p>
<p>其他建表方式</p>
<ul>
<li>复制表结构</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">create table 表名1 like 表名2;	#这样创建的表1和表2的结构是完全一样的</span><br></pre></td></tr></table></figure>

<ul>
<li>执行查询语句，将查询语句的结果，按照顺序作为新标的普通列</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">create table 表名 as select 语句;	#只能建普通表，不能建分区表</span><br></pre></td></tr></table></figure>

<h3 id="删"><a href="#删" class="headerlink" title="删"></a>删</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">drop table 表名	#删除表</span><br><span class="line">truncate table stu_buck_tmp;	#清空管理表</span><br></pre></td></tr></table></figure>

<p><img src="/2021/12/13/Hive/image-20211217120358215.png" alt="image-20211217120358215"></p>
<h3 id="改"><a href="#改" class="headerlink" title="改"></a>改</h3><p>修改表的属性</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">alter table 表名 set tblproperties(属性名=属性值)</span><br></pre></td></tr></table></figure>

<p>对列进行调整</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ALTER TABLE table_name CHANGE [COLUMN] col_old_name col_new_name column_type [COMMENT col_comment] [FIRST|AFTER column_name]		#更新列</span><br><span class="line"></span><br><span class="line">ALTER TABLE table_name ADD|REPLACE COLUMNS (col_name data_type [COMMENT col_comment], ...) 		#增加和替换列</span><br></pre></td></tr></table></figure>

<h3 id="查"><a href="#查" class="headerlink" title="查"></a>查</h3><p><strong>注意：</strong></p>
<ul>
<li>SQL语言大小写不敏感</li>
<li>SQL可以写在一行或多行</li>
<li>关键字不能被缩写也不能被分行</li>
<li>各子句一般要分行，可以使用缩进来提升可读性</li>
</ul>
<p><strong>一些常用的函数</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">select count(*) 列名 from 表名;		#求总行数</span><br><span class="line">select max(列名) 别名 from 表名;		#求最大值</span><br><span class="line">select min(列名) 别名 from 表名;		#求最小值</span><br><span class="line">select sum(列名) 别名 from 表名;		#求和</span><br><span class="line">select avg(列名) 别名 from 表名;		#求均值</span><br></pre></td></tr></table></figure>

<p><strong>比较运算符</strong></p>
<table>
<thead>
<tr>
<th>操作符</th>
<th>支持的数据类型</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>A&lt;=&gt;B</td>
<td>基本数据类型</td>
<td>如果A和B都为NULL，则返回TRUE，其他的和等号（=）操作符的结果一致，如果任一为NULL则结果为NULL</td>
</tr>
<tr>
<td>A RLIKE B, A REGEXP B</td>
<td>STRING 类型</td>
<td>B是一个正则表达式，如果A与其匹配，则返回TRUE；反之返回FALSE。匹配使用的是JDK中的正则表达式接口实现的，因为正则也依据其中的规则。例如，正则表达式必须和整个字符串A相匹配，而不是只需与其字符串匹配。</td>
</tr>
</tbody></table>
<p><strong>数据导入</strong></p>
<p><strong>load：将数据直接加载到表目录中</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">load data [local] inpath &#x27;数据保存的路径&#x27; into table 表名 partition()【分区信息】</span><br></pre></td></tr></table></figure>

<p>loacl：如果导入的文件在本地文件系统，需要加上local，使用put将本地文件上传到hdfs；不加local默认导入的文件是在hdfs，使用mv将源文件移动到目标目录。</p>
<p><strong>insert：insert方式运行MR程序，通过程序将数据输入到表目录</strong></p>
<ul>
<li>使用场景<ul>
<li>向分桶表中插入数据</li>
<li>如果指定表中的数据，不是以纯文本形式存储，需要使用insert方式导入。</li>
</ul>
</li>
</ul>
<p>语法</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">insert into|overwrite table 表名 select xxx | values(),(),()</span><br></pre></td></tr></table></figure>

<p>insert into：向表中追加新的数据</p>
<p>insert overwrite：覆盖写，先清空表中的数据，再向表中添加新的数据</p>
<p><strong>location：在建表的时候，指定表的location为数据存放的目录</strong></p>
<p><strong>import：不仅可以导入数据，还可以导入元数据（表结构）；import只能导入export导出的内容。</strong></p>
<h4 id="数据导出"><a href="#数据导出" class="headerlink" title="数据导出"></a>数据导出</h4><p>insert：将一条sql运算的结果，插入到指定的路径</p>
<p>语法：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">insert overwrite [local] firectory &#x27;/opt/module/datas/export/student&#x27;</span><br><span class="line">row format xxxx		#导出数据的格式</span><br><span class="line">select * from student</span><br></pre></td></tr></table></figure>

<ul>
<li>local：是选填的，写上local表示保存到本地文件系统中</li>
</ul>
<p><img src="/2021/12/13/Hive/image-20211217151317732.png" alt="image-20211217151317732"></p>
<p>export导出（只能导出到HDFS）</p>
<ul>
<li>既能导出数据，也能导出元数据（表结构）；export会在hdfs的导出目录中，生成数据和元数据；导出的元数据是和关系数据库无关的</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export table 表名 [partiton(分区信息)] to &#x27;路径&#x27;;</span><br></pre></td></tr></table></figure>

<p><img src="/2021/12/13/Hive/image-20211217154719251.png" alt="image-20211217154719251"></p>
<p><img src="/2021/12/13/Hive/image-20211217154917567.png" alt="image-20211217154917567"></p>
<p>import导入</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">IMPORT [[EXTERNAL] TABLE 表名（新表或者已经存在的表）[PARTITION (part_column=&quot;value&quot;[,...])]]</span><br><span class="line">FROM &#x27;source_path&#x27;</span><br><span class="line">[LOCATION &#x27;import_target_path&#x27;]</span><br></pre></td></tr></table></figure>

<ul>
<li>如果向一个新表中导入数据，hive会根据要导入表的元数据自动创建表</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">import external table importTable1 from &#x27;/export&#x27;</span><br></pre></td></tr></table></figure>

<p><img src="/2021/12/13/Hive/image-20211217171031567.png" alt="image-20211217171031567"></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">import table importTable2 from &#x27;/export&#x27;</span><br></pre></td></tr></table></figure>

<p><img src="/2021/12/13/Hive/image-20211217171257298.png" alt="image-20211217171257298"></p>
<ul>
<li>如果向一个已经存在的表，导入数据，在导入之前会先检查表的结构和属性是否一致；只有在表的结构和属性一致的情况下，才可以导入。</li>
<li>如果目标表已经存在了，要导入的分区必须是不存在的。</li>
</ul>
<p><img src="/2021/12/13/Hive/image-20211217173130312.png" alt="image-20211217173130312"></p>
<h4 id="排序"><a href="#排序" class="headerlink" title="排序"></a>排序</h4><p>Hive的本质是MR；MR中的排序：</p>
<ul>
<li>全排序：结果只有一个（只有一个分区），所有的数据整体有序。</li>
<li>部分排序：结果有多个（有多个分区），每个分区内部有序。</li>
<li>二次排序：在排序是，比较的条件有多个</li>
</ul>
<p>排序：在reduce之前就已经排序好了，排序是shuffer阶段的任务</p>
<p>建表语句：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">create external table if not exists default.emp(</span><br><span class="line">empno int,</span><br><span class="line">ename string,</span><br><span class="line">job string,</span><br><span class="line">mgr int,</span><br><span class="line">hiredate string, </span><br><span class="line">sal double, </span><br><span class="line">comm double,</span><br><span class="line">deptno int)</span><br><span class="line">row format delimited fields terminated by &#x27;\t&#x27;;</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ORDER BY col_list		#全排序！</span><br><span class="line">SORT BY col_list：		#部分排序！ 设置reduceTaskNum&gt;1。 只写sort by是随机分区！</span><br><span class="line">DISTRIBUTE BY  col_list：#指定按照哪个字段分区！结合sort by 使用！</span><br><span class="line">CLUSTER BY col_list：	# 如果分区的字段和排序的字段一致，可以简写为CLUSTER BY </span><br></pre></td></tr></table></figure>

<p>建表并导入数据</p>
<p><img src="/2021/12/13/Hive/image-20211217180149744.png" alt="image-20211217180149744"></p>
<p>查看结果</p>
<p><img src="/2021/12/13/Hive/image-20211217180216165.png" alt="image-20211217180216165"></p>
<p>在查询中使用order by排序</p>
<p><img src="/2021/12/13/Hive/image-20211218101329919.png" alt="image-20211218101329919"></p>
<p>导出数据</p>
<p>使用sort by</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set mapreduce.job.reduces=5;	#设置分区的个数</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">insert overwrite local directory &#x27;/opt/module/datas/sortby&#x27;</span><br><span class="line">ROW FORMAT DELIMITED FIELDS TERMINATED BY &#x27;\t&#x27;</span><br><span class="line">select * from emp sort by sal desc;</span><br></pre></td></tr></table></figure>

<p><img src="/2021/12/13/Hive/image-20211218103204599.png" alt="image-20211218103204599"></p>
<p>使用DISTRIBUTE BY</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">insert overwrite local directory &#x27;/opt/module/datas/sortby&#x27;</span><br><span class="line">ROW FORMAT DELIMITED FIELDS TERMINATED BY &#x27;\t&#x27;</span><br><span class="line">select * from emp DISTRIBUTE BY deptno sort by sal desc;</span><br></pre></td></tr></table></figure>

<ul>
<li>执行select * from emp DISTRIBUTE BY deptno sort by sal desc；</li>
</ul>
<p><img src="/2021/12/13/Hive/image-20211218144619633.png" alt="image-20211218144619633"></p>
<ul>
<li>导出3个</li>
</ul>
<p><img src="/2021/12/13/Hive/image-20211218145731633.png" alt="image-20211218145731633"></p>
<ul>
<li>导出的结果</li>
</ul>
<p><img src="/2021/12/13/Hive/image-20211218151038575.png" alt="image-20211218151038575"></p>
<p>CLUSTER BY</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">insert overwrite local directory &#x27;/opt/module/datas/sortby&#x27;</span><br><span class="line">ROW FORMAT DELIMITED FIELDS TERMINATED BY &#x27;\t&#x27;</span><br><span class="line">select * from emp where mgr is not null CLUSTER BY mgr;</span><br></pre></td></tr></table></figure>

<p><img src="/2021/12/13/Hive/image-20211218152610820.png" alt="image-20211218152610820"></p>
<h4 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h4><p>函数有库的概念，系统提供的除外，系统提供的函数可以在任何库上使用。</p>
<p>查看函数：show functions;</p>
<p>查看函数的使用：desc function 函数名 </p>
<p><img src="/2021/12/13/Hive/image-20211218161936181.png" alt="image-20211218161936181"></p>
<p>查看函数的详细使用:desc function extended 函数名</p>
<p><img src="/2021/12/13/Hive/image-20211218161916786.png" alt="image-20211218161916786"></p>
<p><strong>函数的分类</strong></p>
<ul>
<li>函数的来源<ul>
<li> 系统自带的，直接使用即可</li>
<li>用户自定义的<ul>
<li>遵守hive函数类的规范，自定义一个函数类</li>
<li>打包函数，打包完成后放到hive的lib目录下，或者，HIVE_HOME/auxlib<ul>
<li>auxlib：用来存放hive可以加载的第三方jar包</li>
</ul>
</li>
<li>创建一个函数，让这个函数和之前编写的类相关联</li>
<li>使用函数</li>
</ul>
</li>
</ul>
</li>
<li>函数的特征<ul>
<li>UDF：用户定义的函数。一进一出，输入单个参数，返回单个结果</li>
<li>UDTF：用户定义的表生成函数。一进多出，传入一个参数，返回一个结果集</li>
<li>UDAF：用户定义的聚集函数。多进一出。传入一列多行，返回一个结果（一列一行）。</li>
</ul>
</li>
</ul>
<h5 id="常用函数"><a href="#常用函数" class="headerlink" title="常用函数"></a>常用函数</h5><p>常用日期函数</p>
<ul>
<li>unix_timestamp:返回当前或指定时间的时间戳</li>
</ul>
<p>不传参数，表示当前时间</p>
<p><img src="/2021/12/13/Hive/image-20211218164808767.png" alt="image-20211218164808767"></p>
<p>可以指定传入日期的格式</p>
<p><img src="/2021/12/13/Hive/image-20211218165008010.png" alt="image-20211218165008010"></p>
<p>from_unixtime：将时间戳转为日期格式</p>
<p><img src="/2021/12/13/Hive/image-20211218165345969.png" alt="image-20211218165345969">current_date：当前日期<br>current_timestamp：当前的日期加时间</p>
<ul>
<li>to_date：抽取日期部分<br>year：获取年<br>month：获取月<br>day：获取日<br>hour：获取时<br>minute：获取分<br>second：获取秒<br>weekofyear：当前时间是一年中的第几周<br>dayofmonth：当前时间是一个月中的第几天</li>
<li>months_between： 两个日期间的月份，前-后</li>
<li>add_months：日期加减月</li>
<li>datediff：两个日期相差的天数，前-后</li>
<li>date_add：日期加天数</li>
<li>date_sub：日期减天数</li>
<li>last_day：日期的当月的最后一天</li>
</ul>
<p>date_format格式化日期   date_format( 2019-11-24 08:09:10,’yyyy-MM’) mn</p>
<p>*常用取整函数<br>round： 四舍五入<br>ceil：  向上取整<br>floor： 向下取整</p>
<p>常用字符串操作函数<br>upper： 转大写<br>lower： 转小写<br>length： 长度</p>
<ul>
<li>trim：  前后去空格<br>lpad： 向左补齐，到指定长度<br>rpad：  向右补齐，到指定长度</li>
<li>regexp_replace： SELECT regexp_replace(‘100-200’, ‘(\d+)’, ‘num’)=’num-num<br>  使用正则表达式匹配目标字符串，匹配成功后替换！</li>
</ul>
<p>集合操作<br>size： 集合（map和list）中元素的个数<br>map_keys： 返回map中的key<br>map_values: 返回map中的value</p>
<ul>
<li>array_contains: 判断array中是否包含某个元素<br>sort_array： 将array中的元素排序</li>
</ul>
<hr>
<ul>
<li>NVL函数</li>
</ul>
<p>NVL(String1,replace_with)：判断string1是否为null，如果为null，就用replace_with替换null；否则不做操作。</p>
<p><img src="/2021/12/13/Hive/image-20211218181739458.png" alt="image-20211218181739458"></p>
<p><img src="/2021/12/13/Hive/image-20211218180517106.png" alt="image-20211218180517106"></p>
<p><img src="/2021/12/13/Hive/image-20211218180735513.png" alt="image-20211218180735513"></p>
<ul>
<li>concat</li>
</ul>
<p>字符串的拼接，可以在参数中传入多个string类型的字符串，如果有一个为null，那么就返回null；</p>
<p><img src="/2021/12/13/Hive/image-20211218181813888.png" alt="image-20211218181813888"></p>
<p><img src="/2021/12/13/Hive/image-20211218182102462.png" alt="image-20211218182102462"></p>
<ul>
<li>concat_ws</li>
</ul>
<p>使用指定的分隔符完成字符串的拼接，</p>
<p><img src="/2021/12/13/Hive/image-20211218182209720.png" alt="image-20211218182209720"></p>
<h4 id="Hive的本地模式"><a href="#Hive的本地模式" class="headerlink" title="Hive的本地模式"></a>Hive的本地模式</h4><p>Hive可以通过本地模式在单台机器上处理所有的任务。对于小数据集，执行时间可以明显被缩短。</p>
<p>用户可以通过设置hive.exec.mode.local.auto的值为true，来让Hive在适当的时候自动启动这个优化。</p>
<p>本地模式只在ReduceTask的个数为1时才有效。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">set hive.exec.mode.local.auto=true;  //开启本地mr</span><br><span class="line">//设置local mr的最大输入数据量，当输入数据量小于这个值时采用local  mr的方式，默认为134217728，即128M</span><br><span class="line">set hive.exec.mode.local.auto.inputbytes.max=50000000;</span><br><span class="line">//设置local mr的最大输入文件个数，当输入文件个数小于这个值时采用local mr的方式，默认为4</span><br><span class="line">set hive.exec.mode.local.auto.input.files.max=10;</span><br></pre></td></tr></table></figure>

<p><img src="/2021/12/13/Hive/image-20211218181156076.png" alt="image-20211218181156076"></p>
<p><img src="/2021/12/13/Hive/image-20211218181112805.png" alt="image-20211218181112805"></p>
<p><img src="/2021/12/13/Hive/image-20211218181304966.png" alt="image-20211218181304966"></p>
<p>练习：</p>
<p>求男女员工的人数</p>
<ul>
<li>建表，并导入数据</li>
</ul>
<p><img src="/2021/12/13/Hive/image-20211218195951498.png" alt="image-20211218195951498"></p>
<ul>
<li>思路：按照性别过滤，求这个性别有多少人，再将同一个部分男女性别各有多少人Join后拼接成一个结果。</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> t1.dept_id,male_count,female_count</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">(<span class="keyword">select</span> dept_id,<span class="built_in">count</span>(<span class="operator">*</span>) male_count <span class="keyword">from</span> emp_sex</span><br><span class="line"><span class="keyword">where</span> sex<span class="operator">=</span><span class="string">&#x27;男&#x27;</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> dept_id) t1</span><br><span class="line"><span class="keyword">join</span></span><br><span class="line">(<span class="keyword">select</span> dept_id,<span class="built_in">count</span>(<span class="operator">*</span>) female_count <span class="keyword">from</span> emp_sex</span><br><span class="line"><span class="keyword">where</span> sex<span class="operator">=</span><span class="string">&#x27;女&#x27;</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> dept_id) t2</span><br><span class="line"><span class="keyword">on</span> t1.dept_id<span class="operator">=</span>t2.dept_id;</span><br></pre></td></tr></table></figure>

<p>输出的结果</p>
<p><img src="/2021/12/13/Hive/image-20211218200741444.png" alt="image-20211218200741444"></p>
<p>尽量避免子查询，因为每个子查询都会创建一个job，会影响程序运行的速度</p>
<ul>
<li>思路：在求男性总数时，求男性总数，可以使用sum(数字)，需要将每个人的性别，由男|女转为数字。<ul>
<li>在求男性总数时，如果当前人的性别为男，记1；</li>
<li>在求女性总数时，如果当前人的性别为女，记1；</li>
</ul>
</li>
<li>判断函数<ul>
<li>case…when…：case 列名 when 值1(原值) then 值2(新值)</li>
</ul>
</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">  dept_id,</span><br><span class="line">  <span class="built_in">sum</span>(<span class="keyword">case</span> sex <span class="keyword">when</span> <span class="string">&#x27;男&#x27;</span> <span class="keyword">then</span> <span class="number">1</span> <span class="keyword">else</span> <span class="number">0</span> <span class="keyword">end</span>) male_count,</span><br><span class="line">  <span class="built_in">sum</span>(<span class="keyword">case</span> sex <span class="keyword">when</span> <span class="string">&#x27;女&#x27;</span> <span class="keyword">then</span> <span class="number">1</span> <span class="keyword">else</span> <span class="number">0</span> <span class="keyword">end</span>) female_count</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">  emp_sex</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">  dept_id;</span><br></pre></td></tr></table></figure>

<p><img src="/2021/12/13/Hive/image-20211218201016535.png" alt="image-20211218201016535"></p>
<p><strong>行转列：一列N行，转成1列N行</strong></p>
<p>collect_set &amp; collect_list</p>
<ul>
<li>collect_set(列名)：将此列的多行记录合并成一个set集合</li>
<li>collect_list(列名)：</li>
</ul>
<p><img src="/2021/12/13/Hive/image-20211218212438040.png" alt="image-20211218212438040"></p>
<p>准备数据</p>
<p><img src="/2021/12/13/Hive/image-20211218211153426.png" alt="image-20211218211153426"></p>
<p>建表，将数据导入</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">create table person_info(</span><br><span class="line">name string, </span><br><span class="line">constellation string, </span><br><span class="line">blood_type string) </span><br><span class="line">row format delimited fields terminated by &quot;\t&quot;;</span><br><span class="line">load data local inpath &#x27;/opt/module/datas/person_info.txt&#x27; into table person_info;</span><br></pre></td></tr></table></figure>

<p>数据导入的结果</p>
<p><img src="/2021/12/13/Hive/image-20211218211749742.png" alt="image-20211218211749742"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">    t1.base,</span><br><span class="line">    concat_ws(<span class="string">&#x27;|&#x27;</span>, collect_set(t1.name)) name</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    (<span class="keyword">select</span></span><br><span class="line">        name,</span><br><span class="line">        concat(constellation, &quot;,&quot;, blood_type) base</span><br><span class="line">    <span class="keyword">from</span></span><br><span class="line">        person_info) t1</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">    t1.base;</span><br></pre></td></tr></table></figure>

<p><img src="/2021/12/13/Hive/image-20211218212050466.png" alt="image-20211218212050466"></p>
<ul>
<li>collect_set：会去重</li>
</ul>
<p><img src="/2021/12/13/Hive/image-20211218212937553.png" alt="image-20211218212937553"></p>
<ul>
<li>collect_list：不会去重</li>
</ul>
<p><img src="/2021/12/13/Hive/image-20211218212957324.png" alt="image-20211218212957324"></p>
<p><strong>列传行</strong></p>
<p>EXPLODE(col)：将hive一列中复杂的array或者map结构拆分成多行。</p>
<ul>
<li>explode(列名)：参数只能时array或者map<ul>
<li>将array类型的参数转为1列N行</li>
<li>将Map类型的参数，转为2列N行</li>
</ul>
</li>
</ul>
<p><img src="/2021/12/13/Hive/image-20211218215233829.png" alt="image-20211218215233829"></p>
<p>LATERAL VIEW</p>
<p>用法：LATERAL VIEW udtf(expression) tableAlias AS columnAlias</p>
<p>解释：用于和split, explode等UDTF一起使用，它能够将一列数据拆成多行数据，在此基础上可以对拆分后的数据进行聚合。</p>
<ul>
<li>准备数据</li>
</ul>
<p><img src="/2021/12/13/Hive/image-20211218213955582.png" alt="image-20211218213955582"></p>
<ul>
<li>建表，并导入数据</li>
</ul>
<p><img src="/2021/12/13/Hive/image-20211218214224259.png" alt="image-20211218214224259"></p>
<ul>
<li>查询结果</li>
</ul>
<p><img src="/2021/12/13/Hive/image-20211218214910459.png" alt="image-20211218214910459"></p>
<p><strong>多列拆分</strong></p>
<p>准备数据</p>
<p><img src="/2021/12/13/Hive/image-20211218225415179.png" alt="image-20211218225415179"></p>
<p>建表并导入数据</p>
<p><img src="/2021/12/13/Hive/image-20211218225704488.png" alt="image-20211218225704488"></p>
<p>查询</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">select name,tag,hobby</span><br><span class="line">from person_info2</span><br><span class="line">lateral view explode(names) tmp1 as name</span><br><span class="line">lateral view explode(tags) tmp1 as tag</span><br><span class="line">lateral view explode(hobbys) tmp1 as hobby;</span><br></pre></td></tr></table></figure>

<p><img src="/2021/12/13/Hive/image-20211218225922631.png" alt="image-20211218225922631"></p>
<h5 id="窗口函数"><a href="#窗口函数" class="headerlink" title="窗口函数"></a><strong>窗口函数</strong></h5><ul>
<li>窗口函数 = 窗口 + 函数<ul>
<li>窗口：函数运行时计算的数据集的范围</li>
<li>函数：运行的函数</li>
<li>支持窗口的函数<ul>
<li>Windowing functions：<ul>
<li>LEAD：LEAD (scalar_expression [,offset] [,default])： 返回当前行以下N行的指定列的列值！</li>
<li>LAG：LAG (scalar_expression [,offset] [,default])： 返回当前行以上N行的指定列的列值！</li>
<li>FIRST_VALUE：FIRST_VALUE(列名,[false(默认)])：  返回当前窗口指定列的第一个值，第二个参数如果为true,代表加入第一个值为null，跳过空值，继续寻找！</li>
<li>LAST_VALUE：LAST_VALUE(列名,[false(默认)])：  返回当前窗口指定列的最后一个值，第二个参数如果为true,代表加入第一个值为null，跳过空值，继续寻找！</li>
</ul>
</li>
<li>统计类的函数(一般都需要结合over使用)： min,max,avg,sum,count</li>
<li>排名分析</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>注意：不是所有的函数在运行时都是可以通过改变窗口的大小，来控制计算数据集的范围</p>
<p>格式：函数    over(partition by 字段，order by 字段 window_clause)【如果over中没有出现order by和window_clause，则默认的范围是上边界和下边界】</p>
<p>窗口的大小可以通过window_clause指定：</p>
<ul>
<li>(rows | range) between (unbounded | [num]) preceding and ([num] preceding | current row | (unbounded | [num]) following)</li>
<li>(rows | range) between current row and (current row | (unbounded | [num]) following)</li>
<li>(rows | range) between [num] following and (unbounded | [num]) following</li>
</ul>
<p>数据准备</p>
<p><img src="/2021/12/13/Hive/image-20211218230427612.png" alt="image-20211218230427612"></p>
<p>建表及数据导入</p>
<p><img src="/2021/12/13/Hive/image-20211218230853908.png" alt="image-20211218230853908"></p>
<p>（1）查询在2017年4月份购买过的顾客及总人数</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> name,<span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">over</span> () </span><br><span class="line"><span class="keyword">from</span> business </span><br><span class="line"><span class="keyword">where</span> <span class="built_in">substring</span>(orderdate,<span class="number">1</span>,<span class="number">7</span>) <span class="operator">=</span> <span class="string">&#x27;2017-04&#x27;</span> </span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> name;</span><br></pre></td></tr></table></figure>

<p><img src="/2021/12/13/Hive/image-20211218231056715.png" alt="image-20211218231056715"></p>
<p>（2）查询顾客的购买明细及月购买总额</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> name, orderdate, cost,<span class="built_in">sum</span>(cost) <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> name,<span class="built_in">substring</span>(orderdate,<span class="number">1</span>,<span class="number">7</span>)) <span class="keyword">from</span> business;</span><br></pre></td></tr></table></figure>

<p><img src="/2021/12/13/Hive/image-20211219100521695.png" alt="image-20211219100521695"></p>
<p>查询顾客购买明细及上次购买时间</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> name,orderdate,cost,<span class="built_in">lag</span>(orderdate,<span class="number">1</span>,<span class="string">&#x27;无数据&#x27;</span>)</span><br><span class="line"><span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> name <span class="keyword">order</span> <span class="keyword">by</span> orderdate)</span><br><span class="line"><span class="keyword">from</span> business;</span><br></pre></td></tr></table></figure>

<p><img src="/2021/12/13/Hive/image-20211219103348285.png" alt="image-20211219103348285"></p>
<p>查询顾客购买明细，及下次购买时间</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> name,orderdate,cost,<span class="built_in">lead</span>(orderdate,<span class="number">1</span>,<span class="string">&#x27;无数据&#x27;</span>)</span><br><span class="line"><span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> name <span class="keyword">order</span> <span class="keyword">by</span> orderdate)</span><br><span class="line"><span class="keyword">from</span> business;</span><br></pre></td></tr></table></figure>

<p><img src="/2021/12/13/Hive/image-20211219103820743.png" alt="image-20211219103820743"></p>
<p>查询顾客购买明细及本月第一次购买的时间</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> name,orderdate,cost,<span class="built_in">FIRST_VALUE</span>(orderdate,<span class="literal">true</span>)</span><br><span class="line"><span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> name,<span class="built_in">substring</span>(orderdate,<span class="number">1</span>,<span class="number">7</span>) <span class="keyword">order</span> <span class="keyword">by</span> orderdate)</span><br><span class="line"><span class="keyword">from</span> business;</span><br></pre></td></tr></table></figure>

<p><img src="/2021/12/13/Hive/image-20211219110134502.png" alt="image-20211219110134502"></p>
<p>查询顾客购买明细及本月最后一次购买的时间【找到下无边界的当前行】</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> name,orderdate,cost,<span class="built_in">LAST_VALUE</span>(orderdate,<span class="literal">true</span>) </span><br><span class="line"><span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> name,<span class="built_in">substring</span>(orderdate,<span class="number">1</span>,<span class="number">7</span>)</span><br><span class="line">     <span class="keyword">order</span> <span class="keyword">by</span> orderdate <span class="keyword">rows</span> <span class="keyword">between</span> <span class="keyword">CURRENT</span>  <span class="type">row</span> <span class="keyword">and</span> UNBOUNDED  FOLLOWING)</span><br><span class="line"><span class="keyword">from</span> business </span><br></pre></td></tr></table></figure>

<p><img src="/2021/12/13/Hive/image-20211219110441814.png" alt="image-20211219110441814"></p>
<p><strong>查询顾客的购买明细及顾客最近三次cost花费</strong></p>
<p>最近三次： 当前和之前两次  或  当前+前一次+后一次</p>
<ul>
<li>当前和之前两次</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> name,orderdate,cost,<span class="built_in">sum</span>(cost)</span><br><span class="line"><span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> name <span class="keyword">order</span> <span class="keyword">by</span> orderdate <span class="keyword">rows</span> <span class="keyword">between</span> <span class="number">2</span> PRECEDING <span class="keyword">and</span> <span class="keyword">CURRENT</span>  <span class="type">row</span>)</span><br><span class="line"><span class="keyword">from</span> business;</span><br></pre></td></tr></table></figure>

<p><img src="/2021/12/13/Hive/image-20211219110841013.png" alt="image-20211219110841013"></p>
<ul>
<li>当前+前一次+后一次</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> name,orderdate,cost,<span class="built_in">sum</span>(cost)</span><br><span class="line"><span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> name <span class="keyword">order</span> <span class="keyword">by</span> orderdate <span class="keyword">rows</span> <span class="keyword">between</span> <span class="number">1</span> PRECEDING <span class="keyword">and</span> <span class="number">1</span>  FOLLOWING)</span><br><span class="line"><span class="keyword">from</span> business;</span><br></pre></td></tr></table></figure>

<p><img src="/2021/12/13/Hive/image-20211219111008511.png" alt="image-20211219111008511"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> name,orderdate,cost,cost<span class="operator">+</span></span><br><span class="line"><span class="built_in">lag</span>(cost,<span class="number">1</span>,<span class="number">0</span>) <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> name <span class="keyword">order</span> <span class="keyword">by</span> orderdate )<span class="operator">+</span></span><br><span class="line"><span class="built_in">lead</span>(cost,<span class="number">1</span>,<span class="number">0</span>) <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> name <span class="keyword">order</span> <span class="keyword">by</span> orderdate )</span><br><span class="line"><span class="keyword">from</span> business;</span><br></pre></td></tr></table></figure>

<p><img src="/2021/12/13/Hive/image-20211219111115592.png" alt="image-20211219111115592"></p>
<h5 id="排名函数"><a href="#排名函数" class="headerlink" title="排名函数"></a>排名函数</h5><ul>
<li>RANK: 允许并列，一旦有并列跳号</li>
<li>ROW_NUMBER: 行号！ 连续的，每个号之间差1</li>
<li>DENSE_RANK： 允许并列，一旦有并列不跳号</li>
<li>CUME_DIST：  从排序后的第一行到当前值之间数据 占整个数据集的百分比</li>
<li>PERCENT_RANK：  rank-1/ 总数据量-1   </li>
<li>NTILE(x):  将数据集均分到X个组中，返回每条记录所在的组号。</li>
</ul>
<p>注意：排名函数可以跟over()，但是不能定义window_clause；在计算名词之前需要先进行排序</p>
<p>准备数据</p>
<p><img src="/2021/12/13/Hive/image-20211219111915750.png" alt="image-20211219111915750"></p>
<p>建表并导入数据</p>
<p><img src="/2021/12/13/Hive/image-20211219112325041.png" alt="image-20211219112325041"></p>
<ul>
<li>根据分数来进行排名</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> , <span class="built_in">rank</span>() <span class="keyword">over</span>(<span class="keyword">order</span> <span class="keyword">by</span> score) ranknum</span><br><span class="line"><span class="keyword">from</span> score;</span><br></pre></td></tr></table></figure>

<p><img src="/2021/12/13/Hive/image-20211219112934790.png" alt="image-20211219112934790"></p>
<p>rank排序允许重复排名，</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> , <span class="built_in">rank</span>() <span class="keyword">over</span>(<span class="keyword">order</span> <span class="keyword">by</span> score) ranknum,</span><br><span class="line"><span class="built_in">ROW_NUMBER</span>() <span class="keyword">over</span>(<span class="keyword">order</span> <span class="keyword">by</span> score) rownum</span><br><span class="line"><span class="keyword">from</span> score;</span><br></pre></td></tr></table></figure>

<p><img src="/2021/12/13/Hive/image-20211219113235111.png" alt="image-20211219113235111"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> , <span class="built_in">rank</span>() <span class="keyword">over</span>(<span class="keyword">order</span> <span class="keyword">by</span> score) ranknum,</span><br><span class="line"><span class="built_in">ROW_NUMBER</span>() <span class="keyword">over</span>(<span class="keyword">order</span> <span class="keyword">by</span> score) rownum,</span><br><span class="line"><span class="built_in">DENSE_RANK</span>() <span class="keyword">over</span>(<span class="keyword">order</span> <span class="keyword">by</span> score) densenum,</span><br><span class="line"><span class="built_in">CUME_DIST</span>() <span class="keyword">over</span>(<span class="keyword">order</span> <span class="keyword">by</span> score) cumenum,</span><br><span class="line"><span class="built_in">PERCENT_RANK</span>() <span class="keyword">over</span>(<span class="keyword">order</span> <span class="keyword">by</span> score) percentnum</span><br><span class="line"><span class="keyword">from</span> score;</span><br></pre></td></tr></table></figure>

<p><img src="/2021/12/13/Hive/image-20211219113603380.png" alt="image-20211219113603380"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> ,<span class="built_in">ntile</span>(<span class="number">5</span>) <span class="keyword">over</span>()</span><br><span class="line"><span class="keyword">from</span> score;</span><br></pre></td></tr></table></figure>

<p><img src="/2021/12/13/Hive/image-20211219121022423.png" alt="image-20211219121022423"></p>
<p>练习</p>
<ul>
<li>按照科目进行排名</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> , <span class="built_in">rank</span>() <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> subject <span class="keyword">order</span> <span class="keyword">by</span> score <span class="keyword">desc</span>)</span><br><span class="line"><span class="keyword">from</span> score;</span><br></pre></td></tr></table></figure>

<p><img src="/2021/12/13/Hive/image-20211219121420986.png" alt="image-20211219121420986"></p>
<ul>
<li>给学生的总分进行排名<ul>
<li>1、先求学生的总分</li>
</ul>
</li>
</ul>
<p>注意group by有去重的功能。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> name, sumscore,<span class="built_in">rank</span>() <span class="keyword">over</span>(<span class="keyword">order</span> <span class="keyword">by</span> sumscore <span class="keyword">desc</span>)</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">(<span class="keyword">select</span> name,<span class="built_in">sum</span>(score) sumscore</span><br><span class="line"><span class="keyword">from</span> score</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> name) tmp	<span class="comment">--根据学生的姓名分组</span></span><br></pre></td></tr></table></figure>

<p><img src="/2021/12/13/Hive/image-20211219121948895.png" alt="image-20211219121948895"></p>
<ul>
<li>求每个学生的明细及每个学生的总分和排名</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span>,<span class="built_in">DENSE_RANK</span>() <span class="keyword">over</span>(<span class="keyword">order</span> <span class="keyword">by</span> tmp.sumscore <span class="keyword">desc</span>)</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">(<span class="keyword">select</span> <span class="operator">*</span>,<span class="built_in">sum</span>(score) <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> name)  sumscore</span><br><span class="line"><span class="keyword">from</span> score) tmp</span><br></pre></td></tr></table></figure>

<p><img src="/2021/12/13/Hive/image-20211219122522157.png" alt="image-20211219122522157"></p>
<ul>
<li>只查询每个科目的成绩的前2名</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">(<span class="keyword">select</span> <span class="operator">*</span>,<span class="built_in">rank</span>() <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> subject <span class="keyword">order</span> <span class="keyword">by</span> score <span class="keyword">desc</span>) rn</span><br><span class="line"><span class="keyword">from</span> score) tmp</span><br><span class="line"><span class="keyword">where</span> rn<span class="operator">&lt;=</span><span class="number">2</span></span><br></pre></td></tr></table></figure>

<p><img src="/2021/12/13/Hive/image-20211219122633775.png" alt="image-20211219122633775"></p>
<ul>
<li>查询学生成绩明细，并显示当前科目最高分</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span>,<span class="built_in">max</span>(score) <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> subject)</span><br><span class="line"><span class="keyword">from</span> score</span><br><span class="line"><span class="comment">---------------------------------------------</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span>,<span class="built_in">FIRST_VALUE</span>(score) <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> subject <span class="keyword">order</span> <span class="keyword">by</span> score <span class="keyword">desc</span>)</span><br><span class="line"><span class="keyword">from</span> score</span><br></pre></td></tr></table></figure>

<p><img src="/2021/12/13/Hive/image-20211219122756849.png" alt="image-20211219122756849"></p>
<p><img src="/2021/12/13/Hive/image-20211219122834633.png" alt="image-20211219122834633"></p>
<ul>
<li>查询学生成绩，并显示当前科目最低分</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span>,<span class="built_in">min</span>(score) <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> subject)</span><br><span class="line"><span class="keyword">from</span> score</span><br><span class="line"><span class="comment">--------------------------------------------</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span>,<span class="built_in">FIRST_VALUE</span>(score) <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> subject <span class="keyword">order</span> <span class="keyword">by</span> score )</span><br><span class="line"><span class="keyword">from</span> score</span><br></pre></td></tr></table></figure>

<p><img src="/2021/12/13/Hive/image-20211219122952265.png" alt="image-20211219122952265"></p>
<p><img src="/2021/12/13/Hive/image-20211219123029186.png" alt="image-20211219123029186"></p>
<h5 id="种树题目"><a href="#种树题目" class="headerlink" title="种树题目"></a>种树题目</h5><p>背景说明：<br>以下表记录了用户每天的蚂蚁森林低碳生活领取的记录流水。<br>table_name：user_low_carbon<br>user_id?data_dt??low_carbon</p>
<p>蚂蚁森林植物换购表，用于记录申领环保植物所需要减少的碳排放量<br>table_name:??plant_carbon<br>plant_id?plant_name?low_carbon<br>植物编号    植物名    换购植物所需要的碳</p>
<p>准备数据</p>
<p><img src="/2021/12/13/Hive/image-20211219132840709.png" alt="image-20211219132840709"></p>
<p>建表并导入数据</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> user_low_carbon(user_id String,data_dt String,low_carbon <span class="type">int</span>) <span class="type">row</span> format delimited fields terminated <span class="keyword">by</span> <span class="string">&#x27;\t&#x27;</span>;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> plant_carbon(plant_id string,plant_name String,low_carbon <span class="type">int</span>) <span class="type">row</span> format delimited fields terminated <span class="keyword">by</span> <span class="string">&#x27;\t&#x27;</span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">load data local inpath &#x27;/opt/module/datas/user_low_carbon&#x27; into table user_low_carbon;</span><br><span class="line">load data local inpath &#x27;/opt/module/datas/plant_carbon&#x27; into table plant_carbon;</span><br></pre></td></tr></table></figure>

<p>开启本地模式</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set hive.exec.mode.local.auto=true;</span><br></pre></td></tr></table></figure>

<p>1.蚂蚁森林植物申领统计<br>问题：假设2017年1月1日开始记录低碳数据（user_low_carbon），假设2017年10月1日之前满足申领条件的用户都申领了一颗p004-胡杨，<br>剩余的能量全部用来领取“p002-沙柳”?。<br>统计在10月1日累计申领“p002-沙柳”?排名前10的用户信息；以及他比后一名多领了几颗沙柳。<br>得到的统计结果如下表样式：<br>user_id??plant_count?less_count(比后一名多领了几颗沙柳)</p>
<ul>
<li><p>思路：</p>
<ul>
<li>统计用户在2012-1-1指2017-10-1期间一共收集了多少碳量（t1）</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> user_id,<span class="built_in">sum</span>(low_carbon) sumCarbon</span><br><span class="line"><span class="keyword">from</span> user_low_carbon</span><br><span class="line"><span class="keyword">where</span> regexp_replace(data_dt,<span class="string">&#x27;/&#x27;</span>,<span class="string">&#x27;-&#x27;</span>) <span class="keyword">between</span> <span class="string">&#x27;2017-1-1&#x27;</span> <span class="keyword">and</span> <span class="string">&#x27;2017-10-1&#x27;</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> user_id</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">regexp_replace(data_dt,<span class="string">&#x27;/&#x27;</span>,<span class="string">&#x27;-&#x27;</span>)	<span class="comment">--对于data_dt这一列，将&#x27;/&#x27;替换成&#x27;-&#x27;</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> user_id	<span class="comment">--根据用户的id进行分组</span></span><br><span class="line"><span class="built_in">sum</span>(low_carbon) sumCarbon	<span class="comment">--求和</span></span><br></pre></td></tr></table></figure>

<p><img src="/2021/12/13/Hive/image-20211219143807865.png" alt="image-20211219143807865"></p>
<ul>
<li>统计胡杨和沙柳单价</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> low_carbon huyangCarbon <span class="keyword">from</span> plant_carbon <span class="keyword">where</span> plant_id<span class="operator">=</span><span class="string">&#x27;p004&#x27;</span>; <span class="comment">-- 胡杨（t2）</span></span><br><span class="line"><span class="keyword">select</span> low_carbon shaliuCarbon <span class="keyword">from</span> plant_carbon <span class="keyword">where</span> plant_id<span class="operator">=</span><span class="string">&#x27;p002&#x27;</span>; <span class="comment">--沙柳（t3）</span></span><br></pre></td></tr></table></figure>

<p><img src="/2021/12/13/Hive/image-20211219143918039.png" alt="image-20211219143918039"></p>
<ul>
<li>计算每个用户领取了多少可沙柳（t4）</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> user_id,<span class="built_in">floor</span>((sumCarbon<span class="operator">-</span>huyangCarbon)<span class="operator">/</span>shaliuCarbon) shaliuCount</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> t1 <span class="keyword">join</span> t2 <span class="keyword">join</span> t3</span><br><span class="line"></span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> shaliuCount <span class="keyword">desc</span></span><br><span class="line"></span><br><span class="line">limit <span class="number">11</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">floor</span>((sumCarbon<span class="operator">-</span>huyangCarbon)<span class="operator">/</span>shaliulowcarbon) <span class="comment">-- 计算领取胡杨后，还可以继续领取多少沙柳，如果计算的结果是浮点数，则向下取整。</span></span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> shaliuCount <span class="keyword">desc</span>	<span class="comment">--根据沙柳数量，降序排序</span></span><br><span class="line"></span><br><span class="line">limit <span class="number">11</span> <span class="comment">-- 取前11的信息</span></span><br></pre></td></tr></table></figure>

<ul>
<li>统计前10用户比后一名多多少</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> user_id,shaliuCount,<span class="built_in">rank</span>() <span class="keyword">over</span>(<span class="keyword">order</span> <span class="keyword">by</span> shaliuCount <span class="keyword">desc</span>),</span><br><span class="line">shaliuCount <span class="operator">-</span> <span class="built_in">lead</span>(shaliuCount,<span class="number">1</span>,<span class="number">0</span>) <span class="keyword">over</span>(<span class="keyword">order</span> <span class="keyword">by</span> shaliuCount <span class="keyword">desc</span>)</span><br><span class="line"><span class="keyword">from</span> t4;</span><br></pre></td></tr></table></figure>

<ul>
<li>最终组装</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> user_id,shaliuCount,<span class="built_in">rank</span>() <span class="keyword">over</span>(<span class="keyword">order</span> <span class="keyword">by</span> shaliuCount <span class="keyword">desc</span>),</span><br><span class="line">shaliuCount <span class="operator">-</span> <span class="built_in">lead</span>(shaliuCount,<span class="number">1</span>,<span class="number">0</span>) <span class="keyword">over</span>(<span class="keyword">order</span> <span class="keyword">by</span> shaliuCount <span class="keyword">desc</span>)</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">(<span class="keyword">select</span> user_id,<span class="built_in">floor</span>((sumCarbon<span class="operator">-</span>huyangCarbon)<span class="operator">/</span>shaliuCarbon) shaliuCount</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">(<span class="keyword">select</span> user_id,<span class="built_in">sum</span>(low_carbon) sumCarbon</span><br><span class="line"><span class="keyword">from</span> user_low_carbon</span><br><span class="line"><span class="keyword">where</span> regexp_replace(data_dt,<span class="string">&#x27;/&#x27;</span>,<span class="string">&#x27;-&#x27;</span>) <span class="keyword">between</span> <span class="string">&#x27;2017-1-1&#x27;</span> <span class="keyword">and</span> <span class="string">&#x27;2017-10-1&#x27;</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> user_id) t1 </span><br><span class="line"><span class="keyword">join</span></span><br><span class="line">(<span class="keyword">select</span> low_carbon huyangCarbon <span class="keyword">from</span> plant_carbon <span class="keyword">where</span> plant_id<span class="operator">=</span><span class="string">&#x27;p004&#x27;</span>) t2</span><br><span class="line"><span class="keyword">join</span></span><br><span class="line">(<span class="keyword">select</span> low_carbon shaliuCarbon <span class="keyword">from</span> plant_carbon <span class="keyword">where</span> plant_id<span class="operator">=</span><span class="string">&#x27;p002&#x27;</span>) t3</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> shaliuCount <span class="keyword">desc</span></span><br><span class="line">limit <span class="number">11</span>) t4;</span><br></pre></td></tr></table></figure>

<p><img src="/2021/12/13/Hive/image-20211219153639996.png" alt="image-20211219153639996"></p>
<p><img src="/2021/12/13/Hive/image-20211219153835815.png" alt="image-20211219153835815"></p>
<p><img src="/2021/12/13/Hive/image-20211219153908161.png" alt="image-20211219153908161"></p>
</li>
</ul>
<p>2、蚂蚁森林低碳用户排名分析<br>问题：查询user_low_carbon表中每日流水记录，条件为：<br>用户在2017年，连续三天（或以上）的天数里，<br>每天减少碳排放（low_carbon）都超过100g的用户低碳流水。<br>需要查询返回满足以上条件的user_low_carbon表中的记录流水。<br>例如用户u_002符合条件的记录如下，因为2017/1/2~2017/1/5连续四天的碳排放量之和都大于等于100g：</p>
<ul>
<li><p>思路</p>
<ul>
<li>过滤17年的数据，统计每个用户，每天共收集多少碳（t1）</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> user_id,regexp_replace(data_dt,<span class="string">&#x27;/&#x27;</span>,<span class="string">&#x27;-&#x27;</span>) dt,<span class="built_in">sum</span>(low_carbon) carbonPerDay</span><br><span class="line"><span class="keyword">from</span> user_low_carbon</span><br><span class="line"><span class="keyword">where</span> <span class="keyword">year</span>(regexp_replace(data_dt,<span class="string">&#x27;/&#x27;</span>,<span class="string">&#x27;-&#x27;</span>))<span class="operator">=</span><span class="number">2017</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> user_id,data_dt</span><br></pre></td></tr></table></figure>

<p><img src="/2021/12/13/Hive/image-20211219155052440.png" alt="image-20211219155052440"></p>
<ul>
<li>过滤17年的数据，统计每个用户，每天共收集碳超过100的记录（t1）</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> user_id,regexp_replace(data_dt,<span class="string">&#x27;/&#x27;</span>,<span class="string">&#x27;-&#x27;</span>) dt,<span class="built_in">sum</span>(low_carbon) carbonPerDay</span><br><span class="line"><span class="keyword">from</span> user_low_carbon</span><br><span class="line"><span class="keyword">where</span> <span class="keyword">year</span>(regexp_replace(data_dt,<span class="string">&#x27;/&#x27;</span>,<span class="string">&#x27;-&#x27;</span>))<span class="operator">=</span><span class="number">2017</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> user_id,data_dt</span><br><span class="line"><span class="keyword">having</span> carbonPerDay<span class="operator">&gt;=</span><span class="number">100</span></span><br></pre></td></tr></table></figure>

<p><img src="/2021/12/13/Hive/image-20211219155442631.png" alt="image-20211219155442631"></p>
<ul>
<li>过滤符合连续三天数据的条件<ul>
<li>如果当前日期位于连续三天中的第一天<ul>
<li>使用当前日期减去后一天的日期，差值一定为-1</li>
<li>使用当前日期减去后两天的日期，差值一定为-2</li>
</ul>
</li>
<li>如果当前日期位于连续三天中的第二天<ul>
<li>使用当前日期减去前一天的日期，差值一定为1</li>
<li>使用当前日期减去后一天的日期，差值一定为-1</li>
</ul>
</li>
<li>如果当前日期位于连续三天中的第三天<ul>
<li>使用当前日期减去前一天的日期，差值一定为1</li>
<li>使用当前日期减去前两天的日期，差值一定为2</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>满足上述任意条件，当前日期符合要求。</p>
<ul>
<li>求当前日期和前1，2天；后1，2天的差值</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> user_id,dt,carbonPerDay,</span><br><span class="line">datediff(dt,<span class="built_in">log</span>(dt,<span class="number">1</span>,<span class="string">&#x27;1970-1-1&#x27;</span>) <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> user_id <span class="keyword">order</span> <span class="keyword">by</span> dt)) before1day,</span><br><span class="line">datediff(dt,<span class="built_in">log</span>(dt,<span class="number">2</span>,<span class="string">&#x27;1970-1-1&#x27;</span>) <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> user_id <span class="keyword">order</span> <span class="keyword">by</span> dt)) before2day,</span><br><span class="line">datediff(dt,<span class="built_in">lead</span>(dt,<span class="number">1</span>,<span class="string">&#x27;1970-1-1&#x27;</span>) <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> user_id <span class="keyword">order</span> <span class="keyword">by</span> dt)) after1day,</span><br><span class="line">datediff(dt,<span class="built_in">lead</span>(dt,<span class="number">2</span>,<span class="string">&#x27;1970-1-1&#x27;</span>) <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> user_id <span class="keyword">order</span> <span class="keyword">by</span> dt)) after2day</span><br><span class="line"><span class="keyword">from</span> t1</span><br></pre></td></tr></table></figure>

<ul>
<li>按用户名进行分组，并且排序，那么前一天，就是上一条数据</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">datediff(dt,<span class="number">1</span>,<span class="string">&#x27;1970-1-1&#x27;</span> <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> user_id <span class="keyword">order</span> <span class="keyword">by</span> dt)) pre1diff</span><br></pre></td></tr></table></figure>

<ul>
<li>组合（t2）</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> user_id,dt,carbonPerDay,</span><br><span class="line">datediff(dt,<span class="built_in">lag</span>(dt,<span class="number">1</span>,<span class="string">&#x27;1970-1-1&#x27;</span>) <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> user_id <span class="keyword">order</span> <span class="keyword">by</span> dt)) before1day,</span><br><span class="line">datediff(dt,<span class="built_in">lag</span>(dt,<span class="number">2</span>,<span class="string">&#x27;1970-1-1&#x27;</span>) <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> user_id <span class="keyword">order</span> <span class="keyword">by</span> dt)) before2day,</span><br><span class="line">datediff(dt,<span class="built_in">lead</span>(dt,<span class="number">1</span>,<span class="string">&#x27;1970-1-1&#x27;</span>) <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> user_id <span class="keyword">order</span> <span class="keyword">by</span> dt)) after1day,</span><br><span class="line">datediff(dt,<span class="built_in">lead</span>(dt,<span class="number">2</span>,<span class="string">&#x27;1970-1-1&#x27;</span>) <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> user_id <span class="keyword">order</span> <span class="keyword">by</span> dt)) after2day</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">(<span class="keyword">select</span> user_id,regexp_replace(data_dt,<span class="string">&#x27;/&#x27;</span>,<span class="string">&#x27;-&#x27;</span>) dt,<span class="built_in">sum</span>(low_carbon) carbonPerDay</span><br><span class="line"><span class="keyword">from</span> user_low_carbon</span><br><span class="line"><span class="keyword">where</span> <span class="keyword">year</span>(regexp_replace(data_dt,<span class="string">&#x27;/&#x27;</span>,<span class="string">&#x27;-&#x27;</span>))<span class="operator">=</span><span class="number">2017</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> user_id,data_dt</span><br><span class="line"><span class="keyword">having</span> carbonPerDay<span class="operator">&gt;=</span><span class="number">100</span>) t1;</span><br></pre></td></tr></table></figure>

<p><img src="/2021/12/13/Hive/image-20211219161435128.png" alt="image-20211219161435128"></p>
<ul>
<li>过滤数据</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> user_id,(regexp_replace(data_dt,<span class="string">&#x27;-&#x27;</span>,<span class="string">&#x27;/&#x27;</span>)) dt,carbonPerDay</span><br><span class="line"><span class="keyword">from</span> t2</span><br><span class="line"><span class="keyword">where</span> (after1day<span class="operator">=</span><span class="number">-1</span> <span class="keyword">and</span> after2day<span class="operator">=</span><span class="number">-2</span>)</span><br><span class="line"><span class="keyword">OR</span> (before1day<span class="operator">=</span><span class="number">1</span> <span class="keyword">and</span> after1day<span class="operator">=</span><span class="number">-1</span>)</span><br><span class="line"><span class="keyword">OR</span> (before1day<span class="operator">=</span><span class="number">1</span> <span class="keyword">and</span> before2day<span class="operator">=</span><span class="number">2</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li>组合（t3）</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> user_id,(regexp_replace(dt,<span class="string">&#x27;-&#x27;</span>,<span class="string">&#x27;/&#x27;</span>)) new_dt,carbonPerDay</span><br><span class="line"><span class="keyword">from</span> (<span class="keyword">select</span> user_id,dt,carbonPerDay,</span><br><span class="line">datediff(dt,<span class="built_in">lag</span>(dt,<span class="number">1</span>,<span class="string">&#x27;1970-1-1&#x27;</span>) <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> user_id <span class="keyword">order</span> <span class="keyword">by</span> dt)) before1day,</span><br><span class="line">datediff(dt,<span class="built_in">lag</span>(dt,<span class="number">2</span>,<span class="string">&#x27;1970-1-1&#x27;</span>) <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> user_id <span class="keyword">order</span> <span class="keyword">by</span> dt)) before2day,</span><br><span class="line">datediff(dt,<span class="built_in">lead</span>(dt,<span class="number">1</span>,<span class="string">&#x27;1970-1-1&#x27;</span>) <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> user_id <span class="keyword">order</span> <span class="keyword">by</span> dt)) after1day,</span><br><span class="line">datediff(dt,<span class="built_in">lead</span>(dt,<span class="number">2</span>,<span class="string">&#x27;1970-1-1&#x27;</span>) <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> user_id <span class="keyword">order</span> <span class="keyword">by</span> dt)) after2day</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">(<span class="keyword">select</span> user_id,regexp_replace(data_dt,<span class="string">&#x27;/&#x27;</span>,<span class="string">&#x27;-&#x27;</span>) dt,<span class="built_in">sum</span>(low_carbon) carbonPerDay</span><br><span class="line"><span class="keyword">from</span> user_low_carbon</span><br><span class="line"><span class="keyword">where</span> <span class="keyword">year</span>(regexp_replace(data_dt,<span class="string">&#x27;/&#x27;</span>,<span class="string">&#x27;-&#x27;</span>))<span class="operator">=</span><span class="number">2017</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> user_id,data_dt</span><br><span class="line"><span class="keyword">having</span> carbonPerDay<span class="operator">&gt;=</span><span class="number">100</span>) t1) t2</span><br><span class="line"><span class="keyword">where</span> (after1day<span class="operator">=</span><span class="number">-1</span> <span class="keyword">and</span> after2day<span class="operator">=</span><span class="number">-2</span>)</span><br><span class="line"><span class="keyword">OR</span> (before1day<span class="operator">=</span><span class="number">1</span> <span class="keyword">and</span> after1day<span class="operator">=</span><span class="number">-1</span>)</span><br><span class="line"><span class="keyword">OR</span> (before1day<span class="operator">=</span><span class="number">1</span> <span class="keyword">and</span> before2day<span class="operator">=</span><span class="number">2</span>)</span><br></pre></td></tr></table></figure>

<p><img src="/2021/12/13/Hive/image-20211219162911683.png" alt="image-20211219162911683"></p>
<p><img src="/2021/12/13/Hive/image-20211219162402509.png" alt="image-20211219162402509"></p>
<ul>
<li>关联原表，求出每日的流水</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> u.<span class="operator">*</span></span><br><span class="line"><span class="keyword">from</span> t3 <span class="keyword">join</span> user_low_carbon u</span><br><span class="line"><span class="keyword">on</span> t3.user_id<span class="operator">=</span>u.user_id <span class="keyword">and</span> t3.new_dt<span class="operator">=</span>u.data_dt </span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> u.<span class="operator">*</span></span><br><span class="line"><span class="keyword">from</span> (<span class="keyword">select</span> user_id,(regexp_replace(dt,<span class="string">&#x27;-&#x27;</span>,<span class="string">&#x27;/&#x27;</span>)) new_dt,carbonPerDay</span><br><span class="line"><span class="keyword">from</span> (<span class="keyword">select</span> user_id,dt,carbonPerDay,</span><br><span class="line">datediff(dt,<span class="built_in">lag</span>(dt,<span class="number">1</span>,<span class="string">&#x27;1970-1-1&#x27;</span>) <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> user_id <span class="keyword">order</span> <span class="keyword">by</span> dt)) before1day,</span><br><span class="line">datediff(dt,<span class="built_in">lag</span>(dt,<span class="number">2</span>,<span class="string">&#x27;1970-1-1&#x27;</span>) <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> user_id <span class="keyword">order</span> <span class="keyword">by</span> dt)) before2day,</span><br><span class="line">datediff(dt,<span class="built_in">lead</span>(dt,<span class="number">1</span>,<span class="string">&#x27;1970-1-1&#x27;</span>) <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> user_id <span class="keyword">order</span> <span class="keyword">by</span> dt)) after1day,</span><br><span class="line">datediff(dt,<span class="built_in">lead</span>(dt,<span class="number">2</span>,<span class="string">&#x27;1970-1-1&#x27;</span>) <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> user_id <span class="keyword">order</span> <span class="keyword">by</span> dt)) after2day</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">(<span class="keyword">select</span> user_id,regexp_replace(data_dt,<span class="string">&#x27;/&#x27;</span>,<span class="string">&#x27;-&#x27;</span>) dt,<span class="built_in">sum</span>(low_carbon) carbonPerDay</span><br><span class="line"><span class="keyword">from</span> user_low_carbon</span><br><span class="line"><span class="keyword">where</span> <span class="keyword">year</span>(regexp_replace(data_dt,<span class="string">&#x27;/&#x27;</span>,<span class="string">&#x27;-&#x27;</span>))<span class="operator">=</span><span class="number">2017</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> user_id,data_dt</span><br><span class="line"><span class="keyword">having</span> carbonPerDay<span class="operator">&gt;=</span><span class="number">100</span>) t1) t2</span><br><span class="line"><span class="keyword">where</span> (after1day<span class="operator">=</span><span class="number">-1</span> <span class="keyword">and</span> after2day<span class="operator">=</span><span class="number">-2</span>)</span><br><span class="line"><span class="keyword">OR</span> (before1day<span class="operator">=</span><span class="number">1</span> <span class="keyword">and</span> after1day<span class="operator">=</span><span class="number">-1</span>)</span><br><span class="line"><span class="keyword">OR</span> (before1day<span class="operator">=</span><span class="number">1</span> <span class="keyword">and</span> before2day<span class="operator">=</span><span class="number">2</span>)) t3 </span><br><span class="line"><span class="keyword">join</span> user_low_carbon u</span><br><span class="line"><span class="keyword">on</span> t3.user_id<span class="operator">=</span>u.user_id <span class="keyword">and</span> t3.new_dt<span class="operator">=</span>u.data_dt </span><br></pre></td></tr></table></figure></li>
</ul>
<p>方法2：</p>
<p>连续：</p>
<p>当前有A，B两列，A列的起始值是从a开始，B列的起始值是从b开始</p>
<ul>
<li>假设A列每次递增X，B列每次递增Y</li>
<li>如果A列和B列都是连续递增，A列和B列之间的差值，总是相差（x-y）</li>
<li>如果x=y，A列和B列之间的差值，总是相差0。</li>
</ul>
<p>判断日期是连续的</p>
<p><img src="/2021/12/13/Hive/image-20211219194830567.png" alt="image-20211219194830567"></p>
<ul>
<li>过滤17年的数据，统计每个用户，每天共收集碳超过100的记录（t1）</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> user_id,regexp_replace(data_dt,<span class="string">&#x27;/&#x27;</span>,<span class="string">&#x27;-&#x27;</span>) dt,<span class="built_in">sum</span>(low_carbon) carbonPerDay</span><br><span class="line"><span class="keyword">from</span> user_low_carbon</span><br><span class="line"><span class="keyword">where</span> <span class="keyword">year</span>(regexp_replace(data_dt,<span class="string">&#x27;/&#x27;</span>,<span class="string">&#x27;-&#x27;</span>))<span class="operator">=</span><span class="number">2017</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> user_id,data_dt</span><br><span class="line"><span class="keyword">having</span> carbonPerDay<span class="operator">&gt;=</span><span class="number">100</span></span><br></pre></td></tr></table></figure>

<ul>
<li></li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> user_id,dt,carbonPerDay,<span class="built_in">row_number</span>() <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> user_id <span class="keyword">order</span> <span class="keyword">by</span> dt)</span><br><span class="line"><span class="keyword">from</span> (<span class="keyword">select</span> user_id,regexp_replace(data_dt,<span class="string">&#x27;/&#x27;</span>,<span class="string">&#x27;-&#x27;</span>) dt,<span class="built_in">sum</span>(low_carbon) carbonPerDay</span><br><span class="line"><span class="keyword">from</span> user_low_carbon</span><br><span class="line"><span class="keyword">where</span> <span class="keyword">year</span>(regexp_replace(data_dt,<span class="string">&#x27;/&#x27;</span>,<span class="string">&#x27;-&#x27;</span>))<span class="operator">=</span><span class="number">2017</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> user_id,data_dt</span><br><span class="line"><span class="keyword">having</span> carbonPerDay<span class="operator">&gt;=</span><span class="number">100</span>) t1</span><br></pre></td></tr></table></figure>

<p><img src="/2021/12/13/Hive/image-20211219195151631.png" alt="image-20211219195151631"></p>
<p><img src="/2021/12/13/Hive/image-20211219195208658.png" alt="image-20211219195208658"></p>
<ul>
<li>日期和row_number做差（t2）</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> user_id,dt,carbonPerDay,date_sub(dt,<span class="built_in">row_number</span>() <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> user_id <span class="keyword">order</span> <span class="keyword">by</span> dt)) diff </span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">(<span class="keyword">select</span> user_id,regexp_replace(data_dt,<span class="string">&#x27;/&#x27;</span>,<span class="string">&#x27;-&#x27;</span>) dt,<span class="built_in">sum</span>(low_carbon) carbonPerDay</span><br><span class="line"><span class="keyword">from</span> user_low_carbon</span><br><span class="line"><span class="keyword">where</span> <span class="keyword">year</span>(regexp_replace(data_dt,<span class="string">&#x27;/&#x27;</span>,<span class="string">&#x27;-&#x27;</span>))<span class="operator">=</span><span class="number">2017</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> user_id,data_dt</span><br><span class="line"><span class="keyword">having</span> carbonPerDay<span class="operator">&gt;=</span><span class="number">100</span>) t1;</span><br></pre></td></tr></table></figure>

<p><img src="/2021/12/13/Hive/image-20211219195855269.png" alt="image-20211219195855269"></p>
<p><img src="/2021/12/13/Hive/image-20211219200044901.png" alt="image-20211219200044901"></p>
<ul>
<li>判断连续的天数超过3天（t3）</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> user_id,dt,carbonPerDay,diff,<span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> user_id,diff) diffcount</span><br><span class="line"><span class="keyword">from</span> t2;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> user_id,diff	<span class="comment">--根据user_id和diff进行分组 </span></span><br></pre></td></tr></table></figure>

<p>使用group by进行分组，有去重的效果，不能使用分组，要用分区</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> user_id,dt,carbonPerDay,diff,<span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> user_id,diff) diffcount</span><br><span class="line"><span class="keyword">from</span> (<span class="keyword">select</span> user_id,dt,carbonPerDay,date_sub(dt,<span class="built_in">row_number</span>() <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> user_id <span class="keyword">order</span> <span class="keyword">by</span> dt)) diff </span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">(<span class="keyword">select</span> user_id,regexp_replace(data_dt,<span class="string">&#x27;/&#x27;</span>,<span class="string">&#x27;-&#x27;</span>) dt,<span class="built_in">sum</span>(low_carbon) carbonPerDay</span><br><span class="line"><span class="keyword">from</span> user_low_carbon</span><br><span class="line"><span class="keyword">where</span> <span class="keyword">year</span>(regexp_replace(data_dt,<span class="string">&#x27;/&#x27;</span>,<span class="string">&#x27;-&#x27;</span>))<span class="operator">=</span><span class="number">2017</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> user_id,data_dt</span><br><span class="line"><span class="keyword">having</span> carbonPerDay<span class="operator">&gt;=</span><span class="number">100</span>) t1) t2;</span><br></pre></td></tr></table></figure>

<ul>
<li>过滤超过3天的数据（t4）</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> user_id,dt</span><br><span class="line"><span class="keyword">from</span> t3</span><br><span class="line"><span class="keyword">where</span> diffcount<span class="operator">&gt;=</span><span class="number">3</span></span><br></pre></td></tr></table></figure>



<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> user_id,dt</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">(<span class="keyword">select</span> user_id,dt,carbonPerDay,diff,<span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> user_id,diff) diffcount</span><br><span class="line"><span class="keyword">from</span> (<span class="keyword">select</span> user_id,dt,carbonPerDay,date_sub(dt,<span class="built_in">row_number</span>() <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> user_id <span class="keyword">order</span> <span class="keyword">by</span> dt)) diff </span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">(<span class="keyword">select</span> user_id,regexp_replace(data_dt,<span class="string">&#x27;/&#x27;</span>,<span class="string">&#x27;-&#x27;</span>) dt,<span class="built_in">sum</span>(low_carbon) carbonPerDay</span><br><span class="line"><span class="keyword">from</span> user_low_carbon</span><br><span class="line"><span class="keyword">where</span> <span class="keyword">year</span>(regexp_replace(data_dt,<span class="string">&#x27;/&#x27;</span>,<span class="string">&#x27;-&#x27;</span>))<span class="operator">=</span><span class="number">2017</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> user_id,data_dt</span><br><span class="line"><span class="keyword">having</span> carbonPerDay<span class="operator">&gt;=</span><span class="number">100</span>) t1) t2) t3</span><br><span class="line"><span class="keyword">where</span> diffcount<span class="operator">&gt;=</span><span class="number">3</span></span><br></pre></td></tr></table></figure>

<p><img src="/2021/12/13/Hive/image-20211219201332460.png" alt="image-20211219201332460"></p>
<p><img src="/2021/12/13/Hive/image-20211219201352435.png" alt="image-20211219201352435"></p>
<ul>
<li>关联原表 - 求出结果</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="自定义函数"><a href="#自定义函数" class="headerlink" title="自定义函数"></a>自定义函数</h2><ul>
<li><p>1、先编写自定义函数</p>
</li>
<li><p>2、打包</p>
</li>
<li><p>3、安装</p>
</li>
<li><p>4、创建函数</p>
</li>
</ul>
<p>导入相关依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.hive<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hive-exec<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>自定义UDF函数，继承UDF类</p>
<p>提供evaluate()，可以提供多个重载的此方法，但是方法名是固定的</p>
<p>evaluate()不能返回void，但是可以返回null</p>
<p>上传jar包，到hive安装目录，新建auxlib文件夹，将创建的jar包上传到该文件夹下。</p>
<p><img src="/2021/12/13/Hive/image-20211220100606692.png" alt="image-20211220100606692"></p>
<p><img src="/2021/12/13/Hive/image-20211220102527430.png" alt="image-20211220102527430"></p>
<p>创建自定义的函数</p>
<p>注意用户自定义函数，有库的范围限制。指定库下创建函数，只在指定库下有效。</p>
<p>新建一个库mydb</p>
<p><img src="/2021/12/13/Hive/image-20211220103645233.png" alt="image-20211220103645233"></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">create [temporary] function 函数 as 自定义函数的全类名</span><br></pre></td></tr></table></figure>

<ul>
<li>temporary表示临时函数，只在当前窗口有效</li>
</ul>
<p><img src="/2021/12/13/Hive/image-20211220104230125.png" alt="image-20211220104230125"></p>
<p>查看数据库</p>
<p><img src="/2021/12/13/Hive/image-20211220104450881.png" alt="image-20211220104450881"></p>
<p>调用</p>
<p><img src="/2021/12/13/Hive/image-20211220104321332.png" alt="image-20211220104321332"></p>
<p>在其他库中调用，需要库名加上函数名进行调用</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> mydb.haha(<span class="string">&#x27;tom&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p><img src="/2021/12/13/Hive/image-20211220104726805.png" alt="image-20211220104726805"></p>
<h2 id="压缩和存储"><a href="#压缩和存储" class="headerlink" title="压缩和存储"></a>压缩和存储</h2><p>检查本地hadoop环境以及支持的类库是否可用</p>
<p><img src="/2021/12/13/Hive/image-20211220105111234.png" alt="image-20211220105111234"></p>
<p>结果表示当前不支持Snappy</p>
<h3 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h3><p><strong>使用root用户进行以下工作</strong></p>
<h4 id="软件准备"><a href="#软件准备" class="headerlink" title="软件准备"></a>软件准备</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">（1）hadoop-2.7.2-src.tar.gz</span><br><span class="line">（2）jdk-8u144-linux-x64.tar.gz</span><br><span class="line">（3）snappy-1.1.3.tar.gz</span><br><span class="line">（4）apache-maven-3.0.5-bin.tar.gz</span><br><span class="line">（5）protobuf-2.5.0.tar.gz</span><br></pre></td></tr></table></figure>

<h4 id="准备编译环境"><a href="#准备编译环境" class="headerlink" title="准备编译环境"></a>准备编译环境</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">yum install svn</span><br><span class="line">yum install autoconf automake libtool cmake</span><br><span class="line">yum install ncurses-devel</span><br><span class="line">yum install openssl-devel</span><br><span class="line">yum install gcc*</span><br></pre></td></tr></table></figure>

<p>安装上述所有依赖</p>
<ul>
<li>1、下载hadoop-2.7.2-src.tar.gz源码包</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://archive.apache.org/dist/hadoop/common/hadoop-2.7.2/hadoop-2.7.2-src.tar.gz </span><br></pre></td></tr></table></figure>

<ul>
<li>2、安装JDK（已安装）</li>
</ul>
<p><img src="/2021/12/13/Hive/image-20211220180513718.png" alt="image-20211220180513718"></p>
<ul>
<li>3、安装maven</li>
</ul>
<p><img src="/2021/12/13/Hive/image-20211220180613384.png" alt="image-20211220180613384"></p>
<ul>
<li>4、解压安装snappy-1.1.3.tar.gz，按顺序执行以下命令，解压并安装</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">tar -zxvf snappy-1.1.3.tar.gz -C /opt/module/</span><br><span class="line">cd snappy-1.1.3/</span><br><span class="line">./configure</span><br><span class="line">make</span><br><span class="line">make install</span><br></pre></td></tr></table></figure>

<ul>
<li>查看安装后的结果</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ls -lh /usr/local/lib |grep snappy</span><br></pre></td></tr></table></figure>

<p><img src="/2021/12/13/Hive/image-20211220181104420.png" alt="image-20211220181104420"></p>
<ul>
<li>5、解压安装protobuf-2.5.0.tar.gz，按顺序执行以下命令，解压并安装</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">tar -zxvf protobuf-2.5.0.tar.gz -C /opt/module/</span><br><span class="line">cd protobuf-2.5.0/</span><br><span class="line">./configure </span><br><span class="line">make </span><br><span class="line">make install</span><br></pre></td></tr></table></figure>

<ul>
<li>查看安装后的结果</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">protoc --version</span><br></pre></td></tr></table></figure>

<p><img src="/2021/12/13/Hive/image-20211220181315400.png" alt="image-20211220181315400"></p>
<ul>
<li>编译hadoop的源码</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">tar -zxvf hadoop-2.7.2-src.tar.gz</span><br><span class="line"></span><br><span class="line">cd hadoop-2.7.2-src/</span><br><span class="line"></span><br><span class="line">mvn clean package -DskipTests -Pdist,native -Dtar -Dsnappy.lib=/usr/local/lib -Dbundle.snappy</span><br></pre></td></tr></table></figure>

<p><img src="/2021/12/13/Hive/image-20211220181532444.png" alt="image-20211220181532444"></p>
<p>编译完成后，目标文件的位置</p>
<p><img src="/2021/12/13/Hive/image-20211220181709292.png" alt="image-20211220181709292"></p>
<p>源代码编译完成</p>
<p>将编译后打压缩包解压，使用其中的lib文件，替换原始的lib文件</p>
<p><img src="/2021/12/13/Hive/image-20211220195015486.png" alt="image-20211220195015486"></p>
<p>再次检查</p>
<p><img src="/2021/12/13/Hive/image-20211220195057208.png" alt="image-20211220195057208"></p>
<p>参考</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">https://blog.csdn.net/qq_42599616/article/details/105980375</span><br><span class="line">https://blog.csdn.net/qq_37714755/article/details/105116443</span><br></pre></td></tr></table></figure>



<h3 id="在Hive中开启压缩"><a href="#在Hive中开启压缩" class="headerlink" title="在Hive中开启压缩"></a>在Hive中开启压缩</h3><p><img src="/2021/12/13/Hive/image-20211220210726672.png" alt="image-20211220210726672"></p>
<p>查看压缩需要开启历史服务</p>
<p><img src="/2021/12/13/Hive/image-20211220205735028.png" alt="image-20211220205735028"></p>
<h4 id="开启Map输出阶段压缩"><a href="#开启Map输出阶段压缩" class="headerlink" title="开启Map输出阶段压缩"></a>开启Map输出阶段压缩</h4><p>开启hive中间传输数据压缩功能</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set hive.exec.compress.intermediate=true;</span><br></pre></td></tr></table></figure>

<p>开启mapreduce中map输出压缩功能</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set mapreduce.map.output.compress=true;</span><br></pre></td></tr></table></figure>

<p>设置mapreduce中map输出数据的压缩方式</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">set mapreduce.map.output.compress.codec=</span><br><span class="line"> org.apache.hadoop.io.compress.SnappyCodec;</span><br></pre></td></tr></table></figure>

<h4 id="开启Reduce输出阶段压缩"><a href="#开启Reduce输出阶段压缩" class="headerlink" title="开启Reduce输出阶段压缩"></a>开启Reduce输出阶段压缩</h4><p>开启hive最终输出数据压缩功能</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set hive.exec.compress.output=true;</span><br></pre></td></tr></table></figure>

<p>开启mapreduce最终输出数据压缩</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set mapreduce.output.fileoutputformat.compress=true;</span><br></pre></td></tr></table></figure>

<p>设置mapreduce最终数据输出压缩方式</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">set mapreduce.output.fileoutputformat.compress.codec =</span><br><span class="line"> org.apache.hadoop.io.compress.SnappyCodec;</span><br></pre></td></tr></table></figure>

<p>设置mapreduce最终数据输出压缩为块压缩（输出文件是SequenceFile需要配置，如果不是则不需要配置）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set mapreduce.output.fileoutputformat.compress.type=BLOCK;</span><br></pre></td></tr></table></figure>

<h3 id="Hive文件支持的存储格式"><a href="#Hive文件支持的存储格式" class="headerlink" title="Hive文件支持的存储格式"></a>Hive文件支持的存储格式</h3><p>TEXTFILE 、SEQUENCEFILE、ORC、PARQUET</p>
<p><img src="/2021/12/13/Hive/image-20211220214728689.png" alt="image-20211220214728689"></p>
<p>TEXTFILE和SEQUENCEFILE的存储格式都是基于行存储的；</p>
<p>ORC和PARQUET是基于列式存储的。（列式存储效率高。在Hive中用的较多）【在大数据领域，一般都采用列式存储】</p>
<h4 id="ORC和PARQUET的区别"><a href="#ORC和PARQUET的区别" class="headerlink" title="ORC和PARQUET的区别"></a>ORC和PARQUET的区别</h4><p>ORC：只有在Hive中可以使用（ORC更优，压缩比更高）</p>
<p>PARQUET：clodera公司提供的一个旨在整个hadoop生态系统中设计一个通用高效的数据格式；PARQUET格式的文件，不仅Hive支持，hbase,impala，spark等都支持。</p>
<p>总结</p>
<ul>
<li>如果表以TEXTFILE为格式存储数据，可以使用load的方式，否则都必须使用insert into</li>
<li>压缩比：     ORC&gt;PARQUET&gt;TEXTFILE</li>
<li>在查询速度上无明显差别</li>
<li>一般使用ORC(内部使用SNAPPY压缩）</li>
<li> 如果使用Parquet(LZO)</li>
</ul>
<h2 id="ETL"><a href="#ETL" class="headerlink" title="ETL"></a>ETL</h2><h4 id="数据清洗"><a href="#数据清洗" class="headerlink" title="数据清洗"></a>数据清洗</h4><ul>
<li>建表，并导入数据</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> gulivideo_ori(</span><br><span class="line">    videoId string, </span><br><span class="line">    uploader string, </span><br><span class="line">    age <span class="type">int</span>, </span><br><span class="line">    category <span class="keyword">array</span><span class="operator">&lt;</span>string<span class="operator">&gt;</span>, </span><br><span class="line">    length <span class="type">int</span>, </span><br><span class="line">    views <span class="type">int</span>, </span><br><span class="line">    rate <span class="type">float</span>, </span><br><span class="line">    ratings <span class="type">int</span>, </span><br><span class="line">    comments <span class="type">int</span>,</span><br><span class="line">    relatedId <span class="keyword">array</span><span class="operator">&lt;</span>string<span class="operator">&gt;</span>)</span><br><span class="line"><span class="type">row</span> format delimited </span><br><span class="line">fields terminated <span class="keyword">by</span> &quot;\t&quot;</span><br><span class="line">collection items terminated <span class="keyword">by</span> &quot;&amp;&quot;</span><br><span class="line">stored <span class="keyword">as</span> textfile;</span><br></pre></td></tr></table></figure>

<p><img src="/2021/12/13/Hive/image-20211221092221738.png" alt="image-20211221092221738"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> gulivideo_user_ori(</span><br><span class="line">    uploader string,</span><br><span class="line">    videos <span class="type">int</span>,</span><br><span class="line">    friends <span class="type">int</span>)</span><br><span class="line"><span class="type">row</span> format delimited </span><br><span class="line">fields terminated <span class="keyword">by</span> &quot;\t&quot; </span><br><span class="line">stored <span class="keyword">as</span> textfile;</span><br></pre></td></tr></table></figure>

<p><img src="/2021/12/13/Hive/image-20211221092246328.png" alt="image-20211221092246328"></p>
<p><img src="/2021/12/13/Hive/image-20211221092351318.png" alt="image-20211221092351318"></p>
<h4 id="表字段"><a href="#表字段" class="headerlink" title="表字段"></a>表字段</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gulivideo_user_ori(uploader ,videos ,friends )</span><br><span class="line">gulivideo_ori(videoId , uploader , age , category , length ,  views , rate , ratings , comments ,relatedId )</span><br></pre></td></tr></table></figure>

<h4 id="问题1、统计视频观看数Top10"><a href="#问题1、统计视频观看数Top10" class="headerlink" title="问题1、统计视频观看数Top10"></a><strong>问题1、统计视频观看数Top10</strong></h4><p>思路：使用order by按照views字段做一个全局排序即可，同时我们设置只显示前10条。</p>
<p>最终代码：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">    videoId, </span><br><span class="line">    uploader, </span><br><span class="line">    age, </span><br><span class="line">    category, </span><br><span class="line">    length, </span><br><span class="line">    views, </span><br><span class="line">    rate, </span><br><span class="line">    ratings, </span><br><span class="line">    comments </span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">    gulivideo_ori</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> </span><br><span class="line">    views </span><br><span class="line"><span class="keyword">desc</span> limit </span><br><span class="line">    <span class="number">10</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> videoId,views</span><br><span class="line"><span class="keyword">from</span> gulivideo_ori</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> views </span><br><span class="line"><span class="keyword">desc</span> limit <span class="number">10</span></span><br></pre></td></tr></table></figure>

<p><img src="/2021/12/13/Hive/image-20211221100337274.png" alt="image-20211221100337274"></p>
<h4 id="问题2：统计视频类别热度Top10"><a href="#问题2：统计视频类别热度Top10" class="headerlink" title="问题2：统计视频类别热度Top10"></a><strong>问题2：统计视频类别热度Top10</strong></h4><p>思路：</p>
<ol>
<li><p>即统计每个类别有多少个视频，显示出包含视频最多的前10个类别。</p>
</li>
<li><p>我们需要按照类别group by聚合，然后count组内的videoId个数即可。</p>
</li>
<li><p>因为当前表结构为：一个视频对应一个或多个类别。所以如果要group by类别，需要先将类别进行列转行(展开)，然后再进行count即可。</p>
</li>
</ol>
<ul>
<li>先将每个视频类别炸裂（t1）</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> videoId, categoryName,views</span><br><span class="line"><span class="keyword">from</span> gulivideo_ori</span><br><span class="line"><span class="keyword">lateral</span> <span class="keyword">view</span> explode(category) t_catetory <span class="keyword">as</span> categoryName;</span><br></pre></td></tr></table></figure>

<ul>
<li>统计每个类型views总数，并排序取前十</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> categoryName, <span class="built_in">sum</span>(views) sumViews</span><br><span class="line"><span class="keyword">from</span> t1</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> categoryName</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> sumViews <span class="keyword">desc</span></span><br><span class="line">limit <span class="number">10</span></span><br></pre></td></tr></table></figure>

<ul>
<li>组合结果</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> categoryName, <span class="built_in">sum</span>(views) sumViews</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">(<span class="keyword">select</span> videoId, categoryName,views</span><br><span class="line"><span class="keyword">from</span> gulivideo_ori</span><br><span class="line"><span class="keyword">lateral</span> <span class="keyword">view</span> explode(category) t_catetory <span class="keyword">as</span> categoryName) t1</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> categoryName</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> sumViews <span class="keyword">desc</span></span><br><span class="line">limit <span class="number">10</span></span><br></pre></td></tr></table></figure>

<p><img src="/2021/12/13/Hive/image-20211221101544261.png" alt="image-20211221101544261"></p>
<h4 id="问题3：统计出视频观看数最高的20个视频的所属类别以及类别包含Top20视频的个数"><a href="#问题3：统计出视频观看数最高的20个视频的所属类别以及类别包含Top20视频的个数" class="headerlink" title="问题3：统计出视频观看数最高的20个视频的所属类别以及类别包含Top20视频的个数"></a><strong>问题3：统计出视频观看数最高的20个视频的所属类别以及类别包含Top20视频的个数</strong></h4><p>思路：</p>
<ol>
<li><p>先找到观看数最高的20个视频所属条目的所有信息，降序排列</p>
</li>
<li><p>把这20条信息中的category分裂出来(列转行)</p>
</li>
<li><p>最后查询视频分类名称和该分类下有多少个Top20的视频</p>
</li>
</ol>
<ul>
<li>视图：创建视图可以对敏感字段进行保护，只将用户需要的字段暴露在视图中，保护数据隐私</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">view</span> 视图 <span class="keyword">as</span> <span class="keyword">select</span> 语句		<span class="comment">--创建视图的语句</span></span><br></pre></td></tr></table></figure>

<ul>
<li>创建视图</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">view</span> categoryView</span><br><span class="line"><span class="keyword">as</span></span><br><span class="line"><span class="keyword">select</span> videoId, categoryName,views</span><br><span class="line"><span class="keyword">from</span> gulivideo_ori</span><br><span class="line"><span class="keyword">lateral</span> <span class="keyword">view</span> explode(category) t_catetory <span class="keyword">as</span> categoryName;</span><br></pre></td></tr></table></figure>

<p>测试视图是否创建成功</p>
<p><img src="/2021/12/13/Hive/image-20211221102406610.png" alt="image-20211221102406610"></p>
<ul>
<li>统计视频观看数最高的20个视频（t1）</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> videoId,views</span><br><span class="line"><span class="keyword">from</span> gulivideo_ori</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> views </span><br><span class="line"><span class="keyword">desc</span> limit <span class="number">20</span></span><br></pre></td></tr></table></figure>

<ul>
<li>（t2）</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> categoryName, <span class="built_in">count</span>(<span class="operator">*</span>) videoNum</span><br><span class="line"><span class="keyword">from</span> t1 <span class="keyword">join</span> categoryView cv</span><br><span class="line"><span class="keyword">on</span> t1.videoId<span class="operator">=</span>cv.videoid</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> categoryName</span><br></pre></td></tr></table></figure>

<ul>
<li></li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> categoryName, <span class="built_in">count</span>(<span class="operator">*</span>) videoNum</span><br><span class="line"><span class="keyword">from</span> (<span class="keyword">select</span> videoId,views</span><br><span class="line"><span class="keyword">from</span> gulivideo_ori</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> views </span><br><span class="line"><span class="keyword">desc</span> limit <span class="number">20</span>) t1 <span class="keyword">join</span> categoryView cv</span><br><span class="line"><span class="keyword">on</span> t1.videoId<span class="operator">=</span>cv.videoid</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> categoryName</span><br></pre></td></tr></table></figure>

<p><img src="/2021/12/13/Hive/image-20211221103318852.png" alt="image-20211221103318852"></p>
<h4 id="问题4：统计视频观看数Top50所关联视频的所属类别Rank"><a href="#问题4：统计视频观看数Top50所关联视频的所属类别Rank" class="headerlink" title="问题4：统计视频观看数Top50所关联视频的所属类别Rank"></a><strong>问题4：统计视频观看数Top50所关联视频的所属类别Rank</strong></h4><ul>
<li>观看数最高的50个视频（t1）</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> videoId,views,relatedId</span><br><span class="line"><span class="keyword">from</span> gulivideo_ori</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> views  <span class="keyword">desc</span></span><br><span class="line">limit <span class="number">50</span>;</span><br></pre></td></tr></table></figure>

<p><img src="/2021/12/13/Hive/image-20211221104101948.png" alt="image-20211221104101948"></p>
<ul>
<li>炸裂求出所有的关联视频（t2）</li>
</ul>
<p>t1执行后，可能包含重复的</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">distinct</span>(coll) relatedVideoId</span><br><span class="line"><span class="keyword">from</span> t1</span><br><span class="line"><span class="keyword">lateral</span> <span class="keyword">view</span> explode(relatedId) tmp <span class="keyword">as</span> coll</span><br></pre></td></tr></table></figure>

<ul>
<li>求出相关视频所属的类别，以及每个类别的总观看数（t3）</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> categoryName,<span class="built_in">sum</span>(cv.views) sumViews</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">t2 </span><br><span class="line"><span class="keyword">join</span> </span><br><span class="line">categoryView cv </span><br><span class="line"><span class="keyword">on</span> t2.relatedVideoId <span class="operator">=</span> cv.videoId</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> categoryName</span><br></pre></td></tr></table></figure>

<ul>
<li>求出类别的排名</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> categoryName,sumViews,<span class="built_in">rank</span>() <span class="keyword">over</span>(<span class="keyword">order</span> <span class="keyword">by</span> sumViews <span class="keyword">desc</span>)</span><br><span class="line"><span class="keyword">from</span> t3</span><br></pre></td></tr></table></figure>

<ul>
<li>最终</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> categoryName,sumViews,<span class="built_in">rank</span>() <span class="keyword">over</span>(<span class="keyword">order</span> <span class="keyword">by</span> sumViews <span class="keyword">desc</span>)</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">(<span class="keyword">select</span> categoryName,<span class="built_in">sum</span>(cv.views) sumViews</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">(<span class="keyword">select</span> <span class="keyword">distinct</span>(coll) relatedVideoId</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line"> (<span class="keyword">select</span> videoId,views,relatedId</span><br><span class="line"><span class="keyword">from</span> gulivideo_ori</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> views  <span class="keyword">desc</span></span><br><span class="line">limit <span class="number">50</span>) t1</span><br><span class="line"><span class="keyword">lateral</span> <span class="keyword">view</span> explode(relatedId) tmp <span class="keyword">as</span> coll) t2 </span><br><span class="line"><span class="keyword">join</span> </span><br><span class="line">categoryView cv </span><br><span class="line"><span class="keyword">on</span> t2.relatedVideoId <span class="operator">=</span> cv.videoId</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> categoryName) t3</span><br></pre></td></tr></table></figure>

<p><img src="/2021/12/13/Hive/image-20211221130222227.png" alt="image-20211221130222227"></p>
<h4 id="问题5：统计每个类别中的视频热度Top10，以Music为例"><a href="#问题5：统计每个类别中的视频热度Top10，以Music为例" class="headerlink" title="问题5：统计每个类别中的视频热度Top10，以Music为例"></a><strong>问题5：统计每个类别中的视频热度Top10，以Music为例</strong></h4><ul>
<li>创建视图</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">view</span> categoryView</span><br><span class="line"><span class="keyword">as</span></span><br><span class="line"><span class="keyword">select</span> videoId, categoryName,views</span><br><span class="line"><span class="keyword">from</span> gulivideo_ori</span><br><span class="line"><span class="keyword">lateral</span> <span class="keyword">view</span> explode(category) t_catetory <span class="keyword">as</span> categoryName;</span><br></pre></td></tr></table></figure>

<ul>
<li>求每个视频，在每个类别的排名（t1）</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> videoId,categoryName,views,<span class="built_in">rank</span>() <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> categoryName <span class="keyword">order</span> <span class="keyword">by</span> views <span class="keyword">desc</span>) rn</span><br><span class="line"><span class="keyword">from</span> categoryView</span><br></pre></td></tr></table></figure>

<ul>
<li>求每个类别的前十</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> videoId,categoryName,views</span><br><span class="line"><span class="keyword">from</span> t1</span><br><span class="line"><span class="keyword">where</span> rn <span class="operator">&lt;=</span> <span class="number">10</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>最终</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> videoId,categoryName,views</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">(<span class="keyword">select</span> videoId,categoryName,views,<span class="built_in">rank</span>() <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> categoryName <span class="keyword">order</span> <span class="keyword">by</span> views <span class="keyword">desc</span>) rn</span><br><span class="line"><span class="keyword">from</span> categoryView) t1</span><br><span class="line"><span class="keyword">where</span> rn <span class="operator">&lt;=</span> <span class="number">10</span>;</span><br></pre></td></tr></table></figure>

<h4 id="问题6-1：统计上传视频最多的用户Top10以及他们上传的观看次数在前20的视频"><a href="#问题6-1：统计上传视频最多的用户Top10以及他们上传的观看次数在前20的视频" class="headerlink" title="问题6-1：统计上传视频最多的用户Top10以及他们上传的观看次数在前20的视频"></a><strong>问题6-1：统计上传视频最多的用户Top10以及他们上传的观看次数在前20的视频</strong></h4><ul>
<li><p>求上传用户最多的前十（t1）</p>
<ul>
<li>创建视图</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">view</span> categoryView</span><br><span class="line"><span class="keyword">as</span></span><br><span class="line"><span class="keyword">select</span> videoId, categoryName,views</span><br><span class="line"><span class="keyword">from</span> gulivideo_ori</span><br><span class="line"><span class="keyword">lateral</span> <span class="keyword">view</span> explode(category) t_catetory <span class="keyword">as</span> categoryName;</span><br></pre></td></tr></table></figure></li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> uploader,videos</span><br><span class="line"><span class="keyword">from</span> gulivideo_user_ori</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> videos <span class="keyword">desc</span></span><br><span class="line">limit <span class="number">10</span>;</span><br></pre></td></tr></table></figure>

<p><img src="/2021/12/13/Hive/image-20211221132008922.png" alt="image-20211221132008922"></p>
<ul>
<li>求前10用户上传的观看次数在前20的视频</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> video.videoId,video.views</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">t1</span><br><span class="line"><span class="keyword">join</span></span><br><span class="line">gulivideo_ori video</span><br><span class="line"><span class="keyword">on</span></span><br><span class="line">t1.uploader<span class="operator">=</span>video.uploader</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> views <span class="keyword">desc</span></span><br><span class="line">limit <span class="number">10</span></span><br></pre></td></tr></table></figure>

<p><img src="/2021/12/13/Hive/image-20211221133126145.png" alt="image-20211221133126145"></p>
<h4 id="问题6-2：统计上传视频最多的用户Top10以及他们每个人上传的观看次数在前20的视频"><a href="#问题6-2：统计上传视频最多的用户Top10以及他们每个人上传的观看次数在前20的视频" class="headerlink" title="问题6-2：统计上传视频最多的用户Top10以及他们每个人上传的观看次数在前20的视频"></a><strong>问题6-2：统计上传视频最多的用户Top10以及他们每个人上传的观看次数在前20的视频</strong></h4><ul>
<li>（t2）</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> video.videoId,video.views,<span class="built_in">rank</span>() <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> video.uploader <span class="keyword">order</span> <span class="keyword">by</span> video.views <span class="keyword">desc</span>) rn</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">t1</span><br><span class="line"><span class="keyword">join</span></span><br><span class="line">gulivideo_ori video</span><br><span class="line"><span class="keyword">on</span></span><br><span class="line">t1.uploader<span class="operator">=</span>video.uploader</span><br></pre></td></tr></table></figure>

<ul>
<li>从t2表中选取小于等于20的记录(rn&lt;=20)</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> t2.videoId,t2.views,t2.rn</span><br><span class="line"><span class="keyword">from</span> t2</span><br><span class="line"><span class="keyword">where</span> rn <span class="operator">&lt;=</span> <span class="number">20</span></span><br></pre></td></tr></table></figure>

<ul>
<li>最终</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> t2.videoId,t2.views,t2.rn</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">(<span class="keyword">select</span> video.videoId,video.views,<span class="built_in">rank</span>() <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> video.uploader <span class="keyword">order</span> <span class="keyword">by</span> video.views <span class="keyword">desc</span>) rn</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">(<span class="keyword">select</span> uploader,videos</span><br><span class="line"><span class="keyword">from</span> gulivideo_user_ori</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> videos <span class="keyword">desc</span></span><br><span class="line">limit <span class="number">10</span>) t1</span><br><span class="line"><span class="keyword">join</span></span><br><span class="line">gulivideo_ori video</span><br><span class="line"><span class="keyword">on</span></span><br><span class="line">t1.uploader<span class="operator">=</span>video.uploader) t2</span><br><span class="line"><span class="keyword">where</span> rn <span class="operator">&lt;=</span> <span class="number">20</span>;</span><br></pre></td></tr></table></figure>

<h2 id="Fetch抓取"><a href="#Fetch抓取" class="headerlink" title="Fetch抓取"></a>Fetch抓取</h2><p>Fetch抓取是指，Hive中对某些情况的查询可以不必使用MapReduce计算。</p>
<p>把hive.fetch.task.conversion设置成none，然后执行查询语句，都会执行mapreduce程序。</p>
<p>查看原始值：</p>
<p><img src="/2021/12/13/Hive/image-20211221134229189.png" alt="image-20211221134229189"> </p>
<h2 id="本地模式"><a href="#本地模式" class="headerlink" title="本地模式"></a>本地模式</h2><p>reduceTask为1时，才有效。</p>
<h2 id="合理设置Map数"><a href="#合理设置Map数" class="headerlink" title="合理设置Map数"></a>合理设置Map数</h2><h4 id="ORC是否可以切片"><a href="#ORC是否可以切片" class="headerlink" title="ORC是否可以切片"></a>ORC是否可以切片</h4><p>ORC不管是否压缩，都可以切片（ORC+Snappy）</p>
<p>ORC可以切片</p>
<ul>
<li>如果使用的是TextInputFormat，TextInputFormat根据文件的后缀判断是否是一个压缩格式，只要不是压缩格式，都可切；如果是压缩格式，在判断是否使用的是可切片的压缩格式。</li>
<li>如果表创建的时候，使用store as orc，此时这个表的输入格式会使用OrcInputFormat，OrcInputFormat.getSplits()方法中，文件是可切片的，即使使用snappy压缩，也可切</li>
</ul>
<p>Parquet是否可切片</p>
<p>Parquet文件不适用LZO压缩，可以切！</p>
<p>Parquet如果使用了LZO压缩，必须创建index后才可以切。</p>
<ul>
<li>如果表在创建时，使用store as Parquet，此时这个表的输入格式会使用ParquetInputFormat<ul>
<li>ParquetInputFormat继承了FileInputFormat，并没有重写isSplitable()方法</li>
<li>Parquet文件格式在切片时也可以切</li>
</ul>
</li>
</ul>
<p>Parquet+LZO格式的文件，在切片时，是可切的，但是通常我们还会为此文件创建Index</p>
<ul>
<li>创建索引的目的：在读入文件时，使用LZO合理的切片策略，而不是默认的切片策略</li>
<li>因为如果表的存储为Parquet+LZO，因为如果表存储为Parquet+LZO，此时表的输入格式已经不能设置为ParquetInputFormat，而需要设置为LZOInputFormat</li>
</ul>
<h2 id="表优化"><a href="#表优化" class="headerlink" title="表优化"></a>表优化</h2><p>创建原始表</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> ori</span><br><span class="line">(id <span class="type">bigint</span>, <span class="type">time</span> <span class="type">bigint</span>, uid string, keyword string, url_rank <span class="type">int</span>, click_num <span class="type">int</span>, click_url string) </span><br><span class="line"><span class="type">row</span> format delimited fields terminated <span class="keyword">by</span> <span class="string">&#x27;\t&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>创建空id表</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> nullidtable</span><br><span class="line">(id <span class="type">bigint</span>, <span class="type">time</span> <span class="type">bigint</span>, uid string, keyword string, url_rank <span class="type">int</span>, click_num <span class="type">int</span>, click_url string) </span><br><span class="line"><span class="type">row</span> format delimited fields terminated <span class="keyword">by</span> <span class="string">&#x27;\t&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p> 创建join后表的语句</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> jointable2</span><br><span class="line">(id <span class="type">bigint</span>, <span class="type">time</span> <span class="type">bigint</span>, uid string, keyword string, url_rank <span class="type">int</span>, click_num <span class="type">int</span>, click_url string)</span><br><span class="line"><span class="type">row</span> format delimited fields terminated <span class="keyword">by</span> <span class="string">&#x27;\t&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p><img src="/2021/12/13/Hive/image-20211221194956406.png" alt="image-20211221194956406"></p>
<p>导入数据</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">load data local inpath &#x27;/opt/module/datas/ori&#x27; into table ori;</span><br><span class="line">load data local inpath &#x27;/opt/module/datas/nullid&#x27; into table nullidtable;</span><br></pre></td></tr></table></figure>

<p><img src="/2021/12/13/Hive/image-20211221195310768.png" alt="image-20211221195310768"></p>
<p>统计数据的数量</p>
<p><img src="/2021/12/13/Hive/image-20211221195501873.png" alt="image-20211221195501873"></p>
<p><img src="/2021/12/13/Hive/image-20211221195619233.png" alt="image-20211221195619233"></p>
<p>执行join</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">table</span> jointable2</span><br><span class="line"><span class="keyword">select</span> n.<span class="operator">*</span> <span class="keyword">from</span> smalldatatable n <span class="keyword">left</span> <span class="keyword">join</span> ori b <span class="keyword">on</span> n.id <span class="operator">=</span> b.id;</span><br></pre></td></tr></table></figure>



<p>如果A表中有大量c字段为null的数据。如果不对null值处理，此时，会产生数据倾斜！</p>
<ul>
<li>情形一：A left join B  on A.c = b.c<ul>
<li>假如不需要id为null的数据！此时可以将A表中id为null的字段提前过滤，减少MR在执行时，输入的数据量！</li>
<li>解决：    将null值过滤，过滤后再执行Join</li>
</ul>
</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(<span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> A <span class="keyword">where</span> c <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">null</span>)A <span class="keyword">left</span> <span class="keyword">join</span> B  <span class="keyword">on</span> A.c <span class="operator">=</span> b.c</span><br></pre></td></tr></table></figure>

<ul>
<li>情形二： A表中c字段为null的数据也需要，不能过滤，如何解决数据倾斜？<ul>
<li>可以将null替换为一个不影响执行结果的随机值！</li>
<li>注意转换后类型匹配的问题</li>
</ul>
</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">local</span> directory <span class="string">&#x27;/opt/module/datas/joinresult&#x27;</span></span><br><span class="line"><span class="type">row</span> format delimited fields terminated <span class="keyword">by</span> <span class="string">&#x27;\t&#x27;</span></span><br><span class="line"><span class="keyword">select</span> n.<span class="operator">*</span> <span class="keyword">from</span> nullidtable n <span class="keyword">left</span> <span class="keyword">join</span> ori o <span class="keyword">on</span> n.id<span class="operator">=</span>o.id;</span><br><span class="line"></span><br><span class="line"><span class="keyword">set</span> mapreduce.job.reduces<span class="operator">=</span><span class="number">5</span>; <span class="comment">--设置reducesTask的个数为5</span></span><br></pre></td></tr></table></figure>

<p><img src="/2021/12/13/Hive/image-20211221201009767.png" alt="image-20211221201009767"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">local</span> directory <span class="string">&#x27;/opt/module/datas/joinresult&#x27;</span></span><br><span class="line"><span class="keyword">select</span> n.<span class="operator">*</span> <span class="keyword">from</span> nullidtable n <span class="keyword">full</span> <span class="keyword">join</span> ori o <span class="keyword">on</span> </span><br><span class="line"><span class="keyword">case</span> <span class="keyword">when</span> n.id <span class="keyword">is</span> <span class="keyword">null</span> <span class="keyword">then</span> <span class="operator">-</span><span class="built_in">floor</span>(rand()<span class="operator">*</span><span class="number">100</span>) <span class="keyword">else</span> n.id <span class="keyword">end</span> <span class="operator">=</span> o.id;</span><br></pre></td></tr></table></figure>

<p><img src="/2021/12/13/Hive/image-20211221203446639.png" alt="image-20211221203446639"></p>
<h2 id="Group-by-优化"><a href="#Group-by-优化" class="headerlink" title="Group by 优化"></a>Group by 优化</h2><p>示例</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span>  deptno,<span class="built_in">count</span>(<span class="operator">*</span>)</span><br><span class="line"><span class="keyword">from</span> emp</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span>  deptno</span><br></pre></td></tr></table></figure>

<p>此条语句在转为MR时，必须使用deptno进行分区，这样同一个deptno的数据才能分到一个reduceTask,只能执行count操作！<br>不优化，是一个MR！ 如果有一个deptno数据特别多，可能发生reduce端的数据倾斜！</p>
<p><strong>优化： hive.groupby.skewindata = true  自动启用负载均衡，可以避免reduce端的数据倾斜！</strong></p>
<ul>
<li>当此值为true时，将原先的一个Job，转为两个Job！<ul>
<li>第一个Job，随机分区！</li>
<li>第二个Job，以第一个Job计算后的值，再按照deptno进行分区！</li>
</ul>
</li>
</ul>
<h2 id="动态分区"><a href="#动态分区" class="headerlink" title="动态分区"></a>动态分区</h2><p><strong>区表为了将数据分散到表的多个子目录中！在查询时可以使用分区字段进行过滤！</strong></p>
<ul>
<li>1、创建分区表</li>
<li>2、创建分区 </li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> 表名 <span class="keyword">add</span> <span class="keyword">partition</span>(分区列名<span class="operator">=</span>分区列值)</span><br></pre></td></tr></table></figure>

<ul>
<li>3、向分区中导入数据(如果分区不存在，会自动创建)</li>
</ul>
<p>分区类型</p>
<ul>
<li>静态分区：在导入数据时，分区的名称已经确定！</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">load data <span class="keyword">local</span> inpath <span class="string">&#x27;xx&#x27;</span> <span class="keyword">into</span> <span class="keyword">table</span> xxx <span class="keyword">partition</span>(分区列名<span class="operator">=</span>分区列值)</span><br></pre></td></tr></table></figure>

<ul>
<li>动态分区：   在导入数据时，根据数据某一列字段的值是什么，就自动创建分区！<ul>
<li>动态分区需要在动态分区非严格模式才能运行！</li>
<li> 动态分区只能使用insert方式导入数据</li>
<li> 注意字段的顺序问题，分区列必须位于最后一个字段！</li>
</ul>
</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> hive.exec.dynamic.partition.mode<span class="operator">=</span>nonstrict;</span><br></pre></td></tr></table></figure>















































































































































































































<p><img src="/2021/12/13/Hive/image-20211219223607838.png" alt="image-20211219223607838"></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn install:install-file -DgroupId=org.pentaho -DartifactId=pentaho-aggdesigner-algorithm -Dversion=5.1.5-jhyde -Dpackaging=jar -Dfile=D:/pentaho-aggdesigner-algorithm-5.1.5-jhyde.jar</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://public.nexus.pentaho.org/repository/proxy-public-3rd-party-release/org/pentaho/pentaho-aggdesigner-algorithm/5.1.5-jhyde/pentaho-aggdesigner-algorithm-5.1.5-jhyde.jar</span><br></pre></td></tr></table></figure>




        </div>
        <footer class="article-footer">
            



    <a data-url="http://example.com/2021/12/13/Hive/" data-id="clq7zx0g7003i2wvohcjjg5kz" class="article-share-link"><i class="fa fa-share"></i>分享到</a>
<script>
    (function ($) {
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

        </footer>
    </div>
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "BlogPosting",
        "author": {
            "@type": "Person",
            "name": "Wumeng"
        },
        "headline": "Hive",
        "image": "http://example.com/2021/12/13/Hive/i.qqkou.com&app=2002&size=f9999,10000&q=a80&n=0&g=0n&fmt=jpeg",
        "keywords": "数据仓库软件",
        "genre": "大数据",
        "datePublished": "2021-12-13",
        "dateCreated": "2021-12-13",
        "dateModified": "2022-05-31",
        "url": "http://example.com/2021/12/13/Hive/",
        "description": "
The Apache Hive ™ data warehouse software facilitates reading, writing, and managing large datasets residing in distributed storage using SQL. Structure can be projected onto data already in storage.",
        "wordCount": 6942
    }
</script>

</article>

    <section id="comments">
    
        
    <div id="disqus_thread">
        <noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    </div>


    
    </section>



                        </div>
                    </section>
                    <aside id="sidebar">
    <a class="sidebar-toggle" title="Expand Sidebar"><i class="toggle icon"></i></a>
    <div class="sidebar-top">
        <p>关注我 :</p>
        <ul class="social-links">
            
                
                <li>
                    <a class="social-tooltip" title="twitter" href="/" target="_blank" rel="noopener">
                        <i class="icon fa fa-twitter"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="facebook" href="/" target="_blank" rel="noopener">
                        <i class="icon fa fa-facebook"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="stack-overflow" href="/" target="_blank" rel="noopener">
                        <i class="icon fa fa-stack-overflow"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="github" href="https://github.com/ppoffice/hexo-theme-hueman" target="_blank" rel="noopener">
                        <i class="icon fa fa-github"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="weibo" href="/" target="_blank" rel="noopener">
                        <i class="icon fa fa-weibo"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="rss" href="/" target="_blank" rel="noopener">
                        <i class="icon fa fa-rss"></i>
                    </a>
                </li>
                
            
        </ul>
    </div>
    
        
<nav id="article-nav">
    
        <a href="/2021/12/21/Flume/" id="article-nav-newer" class="article-nav-link-wrap">
        <strong class="article-nav-caption">下一篇</strong>
        <p class="article-nav-title">
        
            Flume
        
        </p>
        <i class="icon fa fa-chevron-right" id="icon-chevron-right"></i>
    </a>
    
    
        <a href="/2021/12/08/Zookeeper/" id="article-nav-older" class="article-nav-link-wrap">
        <strong class="article-nav-caption">上一篇</strong>
        <p class="article-nav-title">Zookeeper</p>
        <i class="icon fa fa-chevron-left" id="icon-chevron-left"></i>
        </a>
    
</nav>

    
    <div class="widgets-container">
        
            
                

            
                
    <div class="widget-wrap">
        <h3 class="widget-title">最新文章</h3>
        <div class="widget">
            <ul id="recent-post" class="">
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2023/10/21/%E6%B3%95%E8%80%83/" class="thumbnail">
    
    
        <span class="thumbnail-image thumbnail-none"></span>
    
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"></p>
                            <p class="item-title"><a href="/2023/10/21/%E6%B3%95%E8%80%83/" class="title">法考</a></p>
                            <p class="item-date"><time datetime="2023-10-21T06:54:44.000Z" itemprop="datePublished">2023-10-21</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2023/09/07/%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F/" class="thumbnail">
    
    
        <span class="thumbnail-image thumbnail-none"></span>
    
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"></p>
                            <p class="item-title"><a href="/2023/09/07/%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F/" class="title">微信小程序</a></p>
                            <p class="item-date"><time datetime="2023-09-07T13:10:20.000Z" itemprop="datePublished">2023-09-07</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2023/06/26/mooc-k8s/" class="thumbnail">
    
    
        <span style="background-image:url(/2023/06/26/mooc-k8s/Kubernetes%E5%85%A5%E9%97%A8%E5%88%B0%E8%BF%9B%E9%98%B6.png)" alt="mooc_k8s" class="thumbnail-image"></span>
    
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/%E5%AE%B9%E5%99%A8/">容器</a></p>
                            <p class="item-title"><a href="/2023/06/26/mooc-k8s/" class="title">mooc_k8s</a></p>
                            <p class="item-date"><time datetime="2023-06-26T13:39:45.000Z" itemprop="datePublished">2023-06-26</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2023/04/15/python-adv/" class="thumbnail">
    
    
        <span style="background-image:url(/2023/04/15/python-adv/image-20230415150555194.png)" alt="python_adv" class="thumbnail-image"></span>
    
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/python/">python</a></p>
                            <p class="item-title"><a href="/2023/04/15/python-adv/" class="title">python_adv</a></p>
                            <p class="item-date"><time datetime="2023-04-15T05:50:34.000Z" itemprop="datePublished">2023-04-15</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2023/03/16/pytest/" class="thumbnail">
    
    
        <span class="thumbnail-image thumbnail-none"></span>
    
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"></p>
                            <p class="item-title"><a href="/2023/03/16/pytest/" class="title">pytest</a></p>
                            <p class="item-date"><time datetime="2023-03-16T14:47:20.000Z" itemprop="datePublished">2023-03-16</time></p>
                        </div>
                    </li>
                
            </ul>
        </div>
    </div>

            
                
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">分类</h3>
        <div class="widget">
            <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/NoSQL/">NoSQL</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/python/">python</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/">中间件</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%9F%BA%E7%A1%80/">基础</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/">大数据</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%AD%A6%E4%B9%A0/">学习</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%AE%89%E5%85%A8%E8%AE%BE%E5%A4%87/">安全设备</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%AE%B9%E5%99%A8/">容器</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%AE%97%E6%B3%95/">算法</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E9%A1%B9%E7%9B%AE/">项目</a><span class="category-list-count">3</span></li></ul>
        </div>
    </div>


            
                
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">归档</h3>
        <div class="widget">
            <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/10/">十月 2023</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/09/">九月 2023</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/06/">六月 2023</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/04/">四月 2023</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/03/">三月 2023</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/01/">一月 2023</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/10/">十月 2022</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/09/">九月 2022</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/08/">八月 2022</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/07/">七月 2022</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/06/">六月 2022</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/04/">四月 2022</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/02/">二月 2022</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/01/">一月 2022</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/12/">十二月 2021</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/11/">十一月 2021</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/10/">十月 2021</a><span class="archive-list-count">3</span></li></ul>
        </div>
    </div>


            
                
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">标签</h3>
        <div class="widget">
            <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Django/" rel="tag">Django</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Hadoop/" rel="tag">Hadoop</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/K8S/" rel="tag">K8S</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/K8s/" rel="tag">K8s</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux/" rel="tag">Linux</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hadoop/" rel="tag">hadoop</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/leetcode%E9%A2%98%E8%A7%A3/" rel="tag">leetcode题解</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/pytest/" rel="tag">pytest</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/python/" rel="tag">python</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/scala/" rel="tag">scala</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/shell/" rel="tag">shell</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6/" rel="tag">中间件</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%86%85%E5%AD%98%E8%AE%A1%E7%AE%97/" rel="tag">内存计算</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%9F%BA%E7%A1%80/" rel="tag">基础</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%A4%A7%E6%95%B0%E6%8D%AE/" rel="tag">大数据</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%AD%A6%E4%B9%A0/" rel="tag">学习</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%E8%BD%AF%E4%BB%B6/" rel="tag">数据仓库软件</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/" rel="tag">数据库</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E5%9F%BA%E7%A1%80/" rel="tag">数据结构基础</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/" rel="tag">消息队列</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/" rel="tag">环境搭建</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/" rel="tag">计算机网络</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%9B%86%E7%BE%A4%E7%AE%A1%E7%90%86%E5%B7%A5%E5%85%B7/" rel="tag">集群管理工具</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%A1%B9%E7%9B%AE/" rel="tag">项目</a><span class="tag-list-count">1</span></li></ul>
        </div>
    </div>


            
                
    <div class="widget-wrap widget-float">
        <h3 class="widget-title">标签云</h3>
        <div class="widget tagcloud">
            <a href="/tags/Django/" style="font-size: 15px;">Django</a> <a href="/tags/Hadoop/" style="font-size: 15px;">Hadoop</a> <a href="/tags/K8S/" style="font-size: 10px;">K8S</a> <a href="/tags/K8s/" style="font-size: 10px;">K8s</a> <a href="/tags/Linux/" style="font-size: 10px;">Linux</a> <a href="/tags/hadoop/" style="font-size: 10px;">hadoop</a> <a href="/tags/leetcode%E9%A2%98%E8%A7%A3/" style="font-size: 10px;">leetcode题解</a> <a href="/tags/pytest/" style="font-size: 10px;">pytest</a> <a href="/tags/python/" style="font-size: 20px;">python</a> <a href="/tags/scala/" style="font-size: 10px;">scala</a> <a href="/tags/shell/" style="font-size: 10px;">shell</a> <a href="/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6/" style="font-size: 15px;">中间件</a> <a href="/tags/%E5%86%85%E5%AD%98%E8%AE%A1%E7%AE%97/" style="font-size: 10px;">内存计算</a> <a href="/tags/%E5%9F%BA%E7%A1%80/" style="font-size: 10px;">基础</a> <a href="/tags/%E5%A4%A7%E6%95%B0%E6%8D%AE/" style="font-size: 15px;">大数据</a> <a href="/tags/%E5%AD%A6%E4%B9%A0/" style="font-size: 10px;">学习</a> <a href="/tags/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%E8%BD%AF%E4%BB%B6/" style="font-size: 10px;">数据仓库软件</a> <a href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/" style="font-size: 10px;">数据库</a> <a href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E5%9F%BA%E7%A1%80/" style="font-size: 10px;">数据结构基础</a> <a href="/tags/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/" style="font-size: 10px;">消息队列</a> <a href="/tags/%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/" style="font-size: 10px;">环境搭建</a> <a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/" style="font-size: 10px;">计算机网络</a> <a href="/tags/%E9%9B%86%E7%BE%A4%E7%AE%A1%E7%90%86%E5%B7%A5%E5%85%B7/" style="font-size: 10px;">集群管理工具</a> <a href="/tags/%E9%A1%B9%E7%9B%AE/" style="font-size: 10px;">项目</a>
        </div>
    </div>


            
                
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">链接</h3>
        <div class="widget">
            <ul>
                
                    <li>
                        <a target="_blank" rel="noopener" href="http://hexo.io">Hexo</a>
                    </li>
                
            </ul>
        </div>
    </div>


            
        
    </div>
</aside>

                </div>
            </div>
        </div>
        <footer id="footer">
    <div class="container">
        <div class="container-inner">
            <a id="back-to-top" href="javascript:;"><i class="icon fa fa-angle-up"></i></a>
            <div class="credit">
                <h1 class="logo-wrap">
                    <a href="/" class="logo"></a>
                </h1>
                <p>&copy; 2023 Wumeng</p>
                
                <p>Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>. Theme by <a href="https://github.com/ppoffice" target="_blank">PPOffice</a></p>
                
            </div>
            <div class="parent">
                <div class="child">
                  <span id="busuanzi_container_site_pv">
                    访问量<span id="busuanzi_value_site_pv"></span>次
                  </span>
                  <span class="post-meta-divider">|</span>
                  <span id="busuanzi_container_site_uv" style='display:none'>
                    访客数<span id="busuanzi_value_site_uv"></span>人
                  </span>
                  <script async="" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
                </div>
              </div>              
            <div class="footer-plugins">
              
    


            </div>
        </div>
    </div>
    <style>
        .parent {
          position: relative;
        }
        .child {
          position: absolute;
          left: 50%;
          top: 50%;
          transform: translate(-50%, -50%);
        }
      </style>
      
</footer>

    </div>
    
    
    <script>
    var disqus_shortname = 'hexo-theme-hueman';
    
    
    var disqus_url = 'http://example.com/2021/12/13/Hive/';
    
    (function() {
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    </script>





    
        
<script src="/libs/lightgallery/js/lightgallery.min.js"></script>

        
<script src="/libs/lightgallery/js/lg-thumbnail.min.js"></script>

        
<script src="/libs/lightgallery/js/lg-pager.min.js"></script>

        
<script src="/libs/lightgallery/js/lg-autoplay.min.js"></script>

        
<script src="/libs/lightgallery/js/lg-fullscreen.min.js"></script>

        
<script src="/libs/lightgallery/js/lg-zoom.min.js"></script>

        
<script src="/libs/lightgallery/js/lg-hash.min.js"></script>

        
<script src="/libs/lightgallery/js/lg-share.min.js"></script>

        
<script src="/libs/lightgallery/js/lg-video.min.js"></script>

    
    
        
<script src="/libs/justified-gallery/jquery.justifiedGallery.min.js"></script>

    
    

    
    
    



<!-- Custom Scripts -->

<script src="/js/main.js"></script>


</body>
</html>
